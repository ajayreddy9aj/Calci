<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SAMBASHIVA MILK AGENCY</title>
<style>
  :root{
    --orange:#f97316;
    --orange-dark:#d65b12;
    --muted:#6b7280;
    --bg:#faf7f3;
    --card:#ffffff;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#222}
  header{
    background:linear-gradient(90deg,var(--orange),var(--orange-dark));
    color:white;padding:18px 12px;position:relative;
    box-shadow:0 6px 20px rgba(0,0,0,0.08)
  }
  .logo-left, .logo-right{position:absolute;top:12px;width:56px;height:56px}
  .logo-left{left:12px}
  .logo-right{right:12px}
  .container{max-width:1100px;margin:12px auto;padding:0 12px}
  .title{font-size:1.5rem;font-weight:800;margin:0;text-align:center}
  .sub{margin:6px 0 0;font-size:0.95rem;text-align:center}
  .top-row{display:flex;gap:12px;align-items:center;justify-content:center;flex-wrap:wrap;margin-top:10px}
  .date-wrap{display:flex;gap:8px;align-items:center}
  .date-input,.stock-input{background:var(--card);border:0;padding:8px 10px;border-radius:8px;font-weight:700}
  .price-panel{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:center;margin:12px 0}
  .price-item{background:var(--card);padding:8px 10px;border-radius:8px;box-shadow:0 6px 18px rgba(2,6,23,0.04);display:flex;flex-direction:column;align-items:center;min-width:100px}
  .price-item label{font-size:12px;color:var(--muted);margin-bottom:6px}
  .price-item input{width:86px;padding:6px;border-radius:6px;border:1px solid #e6e6e6;text-align:center}
  .controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:10px 0}
  .btn{background:var(--orange);color:white;border:0;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
  .btn.ghost{background:white;color:var(--orange);border:1px solid rgba(0,0,0,0.06)}
  .table-wrap{overflow:auto;border-radius:10px;background:var(--card);box-shadow:0 8px 30px rgba(2,6,23,0.06)}
  table{width:100%;border-collapse:collapse;min-width:1100px}
  th,td{padding:8px 6px;border-bottom:1px solid #f3f3f3;text-align:center;font-size:13px}
  thead th{background:linear-gradient(180deg,var(--orange),var(--orange-dark));color:white;position:sticky;top:0;z-index:5}
  .summary-litres-row td{background:#fff6ed;color:#000;font-weight:700}
  input[type="text"],input[type="number"],input[type="tel"],input[type="date"]{width:100%;padding:6px;border-radius:6px;border:1px solid #eaeaea;text-align:center;font-size:13px;background:transparent}
  input[type="number"]::-webkit-inner-spin-button,input[type="number"]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
  .total-cell,.due-cell{font-weight:800}
  .send-btn{background:#25D366;border:0;color:white;padding:6px 8px;border-radius:8px;cursor:pointer}
  .delete-btn{background:#ef4444;border:0;color:white;padding:6px 8px;border-radius:8px;cursor:pointer}
  .custom-toggle{transform:scale(1.1);margin-right:6px}
  .footer{margin-top:10px;text-align:center;color:var(--muted);font-size:13px}
  .toast{position:fixed;right:16px;bottom:16px;background:#111;color:#fff;padding:10px 12px;border-radius:8px;opacity:0;transform:translateY(8px);transition:all .18s}
  .toast.show{opacity:1;transform:none}
  @media (max-width:1100px){table{min-width:1000px}}
  @media (max-width:640px){
    .price-item{min-width:88px}
    thead th, td {font-size:12px;padding:6px}
    .title{font-size:1.25rem}
    .logo-left,.logo-right{width:42px;height:42px}
  }
</style>
</head>
<body>
  <header>
    <!-- logos (SVG placeholders) -->
    <div class="logo-left" aria-hidden="true">
      <svg viewBox="0 0 100 100" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
        <circle cx="50" cy="50" r="48" fill="#fff" stroke="#f97316" stroke-width="4"/>
        <text x="50" y="57" font-family="sans-serif" font-weight="800" font-size="26" fill="#f97316" text-anchor="middle">HAP</text>
      </svg>
    </div>
    <div class="logo-right" aria-hidden="true">
      <svg viewBox="0 0 100 100" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
        <circle cx="50" cy="50" r="48" fill="#fff" stroke="#f97316" stroke-width="4"/>
        <text x="50" y="57" font-family="sans-serif" font-weight="800" font-size="26" fill="#f97316" text-anchor="middle">HAP</text>
      </svg>
    </div>

    <div class="container">
      <div class="title">SAMBASHIVA MILK AGENCY</div>
      <div class="sub">Prop: <strong>K. AJAY KUMAR REDDY</strong> &nbsp; | &nbsp; Mobile: <strong>7330892694</strong></div>
      <div class="top-row" style="margin-top:12px">
        <div class="date-wrap small-txt">Date:
          <input id="dateInput" class="date-input" type="date" aria-label="Date"/>
        </div>
        <div class="date-wrap small-txt">Total Litres Available Today:
          <input id="totalAvailable" class="stock-input" type="number" min="0" inputmode="numeric" placeholder="e.g., 500"/>
        </div>
        <div class="small-txt" style="font-weight:700" id="topSoldDisplay">Total Litres Sold: 0</div>
        <div class="small-txt" style="font-weight:700" id="topRemainingDisplay">Remaining: 0</div>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- Price panel -->
    <div class="price-panel" aria-label="Prices">
      <div class="price-item"><label>TM (₹)</label><input id="price_TM" type="number" min="0" value="57"></div>
      <div class="price-item"><label>SM (₹)</label><input id="price_SM" type="number" min="0" value="67"></div>
      <div class="price-item"><label>SMALL M (₹)</label><input id="price_SMM" type="number" min="0" value="45"></div>
      <div class="price-item"><label>SMALL C (₹)</label><input id="price_SMC" type="number" min="0" value="45"></div>
      <div class="price-item"><label>A400 (₹)</label><input id="price_A400" type="number" min="0" value="70"></div>
      <div class="price-item"><label>H500 (₹)</label><input id="price_H500" type="number" min="0" value="86"></div>
      <div class="price-item"><label>FC400 (₹)</label><input id="price_FC400" type="number" min="0" value="77"></div>
      <div class="price-item"><label>FC1L (₹)</label><input id="price_FC1L" type="number" min="0" value="76"></div>
    </div>

    <div class="controls">
      <button id="addBtn" class="btn">+ Add Shop</button>
      <button id="saveBtn" class="btn ghost">Save Data</button>
      <button id="exportBtn" class="btn ghost">Download CSV</button>
    </div>

    <div class="table-wrap" role="region" aria-label="Shops table">
      <table id="dataTable">
        <thead>
          <tr>
            <th>Full name</th><th>Mobile</th><th>TM</th><th>SM</th><th>SMALL M</th><th>SMALL C</th>
            <th>A400</th><th>H500</th><th>FC400</th><th>FC1L</th><th>Total</th><th>Paid</th><th>Due</th><th>Send</th><th>Custom Price</th><th>Delete</th>
          </tr>
        </thead>

        <!-- summary row right under header -->
        <tbody id="summaryBody">
          <tr class="summary-litres-row">
            <td style="text-align:left;padding-left:8px">Total litres sold (per type)</td>
            <td>—</td>
            <td id="sum_tm">0</td>
            <td id="sum_sm">0</td>
            <td id="sum_smm">0</td>
            <td id="sum_smc">0</td>
            <td id="sum_a400">0</td>
            <td id="sum_h500">0</td>
            <td id="sum_fc400">0</td>
            <td id="sum_fc1l">0</td>
            <td id="sum_total">0</td>
            <td id="sum_paid">0</td>
            <td id="sum_due">0</td>
            <td colspan="3"></td>
          </tr>
        </tbody>

        <!-- actual data rows -->
        <tbody id="dataBody"></tbody>

        <tfoot>
          <tr class="summary-row">
            <td style="text-align:left;padding-left:8px">Totals per column</td>
            <td id="tot_mobile" class="small-txt">—</td>
            <td id="tot_tm">0</td>
            <td id="tot_sm">0</td>
            <td id="tot_smm">0</td>
            <td id="tot_smc">0</td>
            <td id="tot_a400">0</td>
            <td id="tot_h500">0</td>
            <td id="tot_fc400">0</td>
            <td id="tot_fc1l">0</td>
            <td id="tot_total">0</td>
            <td id="tot_paid">0</td>
            <td id="tot_due">0</td>
            <td colspan="3"></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <div style="margin-top:12px;text-align:center;font-weight:700">
      Grand Total: ₹<span id="grandTotal">0</span><br>
      Total Litres Sold: <span id="grandLitres">0</span> Ltrs &nbsp; | &nbsp;
      Total Available: <span id="displayAvailable">0</span> Ltrs &nbsp; | &nbsp;
      Remaining Litres: <span id="remainingLitres">0</span> Ltrs
    </div>

    <div class="footer" style="margin-top:10px;text-align:center;color:var(--muted);font-size:13px">
      Saved locally on this device — data persists after refresh/close.
    </div>
  </div>

  <div id="toast" class="toast" aria-hidden="true"></div>

<script>
(() => {
  // storage key
  const STORAGE_KEY = 'sambashivaMilkApp_v1';

  // elements
  const priceInputs = {
    TM: document.getElementById('price_TM'),
    SM: document.getElementById('price_SM'),
    'SMALL M': document.getElementById('price_SMM'),
    'SMALL C': document.getElementById('price_SMC'),
    A400: document.getElementById('price_A400'),
    H500: document.getElementById('price_H500'),
    FC400: document.getElementById('price_FC400'),
    FC1L: document.getElementById('price_FC1L')
  };
  const dataBody = document.getElementById('dataBody');
  const summaryBody = document.getElementById('summaryBody');
  const addBtn = document.getElementById('addBtn');
  const saveBtn = document.getElementById('saveBtn');
  const exportBtn = document.getElementById('exportBtn');
  const dateInput = document.getElementById('dateInput');
  const totalAvailableInput = document.getElementById('totalAvailable');
  const toast = document.getElementById('toast');

  // summary elements
  const sumEls = {
    tm: document.getElementById('sum_tm'),
    sm: document.getElementById('sum_sm'),
    smm: document.getElementById('sum_smm'),
    smc: document.getElementById('sum_smc'),
    a400: document.getElementById('sum_a400'),
    h500: document.getElementById('sum_h500'),
    fc400: document.getElementById('sum_fc400'),
    fc1l: document.getElementById('sum_fc1l'),
    total: document.getElementById('sum_total'),
    paid: document.getElementById('sum_paid'),
    due: document.getElementById('sum_due')
  };
  const footEls = {
    tm: document.getElementById('tot_tm'),
    sm: document.getElementById('tot_sm'),
    smm: document.getElementById('tot_smm'),
    smc: document.getElementById('tot_smc'),
    a400: document.getElementById('tot_a400'),
    h500: document.getElementById('tot_h500'),
    fc400: document.getElementById('tot_fc400'),
    fc1l: document.getElementById('tot_fc1l'),
    total: document.getElementById('tot_total'),
    paid: document.getElementById('tot_paid'),
    due: document.getElementById('tot_due')
  };
  const grandEl = document.getElementById('grandTotal');
  const grandLitresEl = document.getElementById('grandLitres');
  const remainingEl = document.getElementById('remainingLitres');
  const topSoldDisplay = document.getElementById('topSoldDisplay');
  const topRemainingDisplay = document.getElementById('topRemainingDisplay');
  const displayAvailable = document.getElementById('displayAvailable');

  function showToast(msg, ms=1400){
    toast.textContent = msg;
    toast.classList.add('show');
    toast.setAttribute('aria-hidden','false');
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>{ toast.classList.remove('show'); toast.setAttribute('aria-hidden','true'); }, ms);
  }

  function readGlobalPrices(){
    return {
      TM: Number(priceInputs.TM.value || 0),
      SM: Number(priceInputs.SM.value || 0),
      'SMALL M': Number(priceInputs['SMALL M'].value || 0),
      'SMALL C': Number(priceInputs['SMALL C'].value || 0),
      A400: Number(priceInputs.A400.value || 0),
      H500: Number(priceInputs.H500.value || 0),
      FC400: Number(priceInputs.FC400.value || 0),
      FC1L: Number(priceInputs.FC1L.value || 0)
    };
  }

  // create a table row for shop
  function createRow(data){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input class="shop" type="text" placeholder="Full name"/></td>
      <td><input class="mobile" type="tel" placeholder="10-digit mobile"/></td>
      <td><input class="tm" type="number" min="0" inputmode="numeric"/></td>
      <td><input class="sm" type="number" min="0" inputmode="numeric"/></td>
      <td><input class="smm" type="number" min="0" inputmode="numeric"/></td>
      <td><input class="smc" type="number" min="0" inputmode="numeric"/></td>
      <td><input class="a400" type="number" min="0" inputmode="numeric"/></td>
      <td><input class="h500" type="number" min="0" inputmode="numeric"/></td>
      <td><input class="fc400" type="number" min="0" inputmode="numeric"/></td>
      <td><input class="fc1l" type="number" min="0" inputmode="numeric"/></td>
      <td class="total-cell">0</td>
      <td><input class="paid" type="number" min="0" inputmode="numeric"/></td>
      <td class="due-cell">0</td>
      <td><button class="send-btn" type="button">Send</button></td>
      <td><label style="cursor:pointer"><input type="checkbox" class="custom-toggle custom-toggle-check"/> Edit</label></td>
      <td><button class="delete-btn" type="button">Delete</button></td>
    `;

    // populate if data provided
    if(data){
      tr.querySelector('.shop').value = data.shop || '';
      tr.querySelector('.mobile').value = data.mobile || '';
      tr.querySelector('.tm').value = data.TM || '';
      tr.querySelector('.sm').value = data.SM || '';
      tr.querySelector('.smm').value = data.SMALLM || '';
      tr.querySelector('.smc').value = data.SMALLC || '';
      tr.querySelector('.a400').value = data.A400 || '';
      tr.querySelector('.h500').value = data.H500 || '';
      tr.querySelector('.fc400').value = data.FC400 || '';
      tr.querySelector('.fc1l').value = data.FC1L || '';
      tr.querySelector('.paid').value = data.paid || '';
    }

    // attach events to inputs
    tr.querySelectorAll('input').forEach(inp=>{
      inp.addEventListener('input', ()=>{
        calculateRow(tr);
        autosaveSilent();
      });
    });

    // send button
    tr.querySelector('.send-btn').addEventListener('click', ()=> sendWhatsAppForRow(tr));

    // delete with confirm
    tr.querySelector('.delete-btn').addEventListener('click', ()=>{
      if(confirm('Delete this row? This action cannot be undone.')) {
        // if custom editor next, remove it
        if(tr.nextSibling && tr.nextSibling.classList && tr.nextSibling.classList.contains('custom-price-row')) tr.parentNode.removeChild(tr.nextSibling);
        tr.parentNode.removeChild(tr);
        updateTotalsAndLitres();
        autosaveSilent();
      }
    });

    // custom price toggle
    const toggle = tr.querySelector('.custom-toggle-check');
    toggle.addEventListener('change', (e)=>{
      if(e.target.checked) showCustomPriceEditor(tr, data && data.customPrices ? data.customPrices : null);
      else removeCustomPriceEditor(tr);
      calculateRow(tr);
      autosaveSilent();
    });

    // if data contains customPrices, enable editor
    if(data && data.customPrices){
      toggle.checked = true;
      showCustomPriceEditor(tr, data.customPrices);
    }

    return tr;
  }

  // show inline custom price editor beneath row
  function showCustomPriceEditor(tr, customData){
    if(tr.nextSibling && tr.nextSibling.classList && tr.nextSibling.classList.contains('custom-price-row')) return;
    const editor = document.createElement('tr');
    editor.classList.add('custom-price-row');
    editor.innerHTML = `<td colspan="17" style="background:#fff6ee;padding:10px">
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <div style="font-weight:700;margin-right:12px">Custom prices for this customer:</div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <label>TM ₹<input class="cust-price-tm" type="number" min="0" style="width:90px;padding:6px;margin-left:6px" /></label>
          <label>SM ₹<input class="cust-price-sm" type="number" min="0" style="width:90px;padding:6px;margin-left:6px" /></label>
          <label>SMALL M ₹<input class="cust-price-smm" type="number" min="0" style="width:90px;padding:6px;margin-left:6px" /></label>
          <label>SMALL C ₹<input class="cust-price-smc" type="number" min="0" style="width:90px;padding:6px;margin-left:6px" /></label>
          <label>A400 ₹<input class="cust-price-a400" type="number" min="0" style="width:90px;padding:6px;margin-left:6px" /></label>
          <label>H500 ₹<input class="cust-price-h500" type="number" min="0" style="width:90px;padding:6px;margin-left:6px" /></label>
          <label>FC400 ₹<input class="cust-price-fc400" type="number" min="0" style="width:90px;padding:6px;margin-left:6px" /></label>
          <label>FC1L ₹<input class="cust-price-fc1l" type="number" min="0" style="width:90px;padding:6px;margin-left:6px" /></label>
        </div>
      </div>
    </td>`;
    tr.parentNode.insertBefore(editor, tr.nextSibling);

    // populate if customData
    if(customData){
      editor.querySelector('.cust-price-tm').value = customData.TM || '';
      editor.querySelector('.cust-price-sm').value = customData.SM || '';
      editor.querySelector('.cust-price-smm').value = customData['SMALL M'] || '';
      editor.querySelector('.cust-price-smc').value = customData['SMALL C'] || '';
      editor.querySelector('.cust-price-a400').value = customData.A400 || '';
      editor.querySelector('.cust-price-h500').value = customData.H500 || '';
      editor.querySelector('.cust-price-fc400').value = customData.FC400 || '';
      editor.querySelector('.cust-price-fc1l').value = customData.FC1L || '';
    }

    editor.querySelectorAll('input').forEach(i=>{
      i.addEventListener('input', ()=> { calculateRow(tr); autosaveSilent(); });
    });
  }

  function removeCustomPriceEditor(tr){
    if(tr.nextSibling && tr.nextSibling.classList && tr.nextSibling.classList.contains('custom-price-row')){
      tr.parentNode.removeChild(tr.nextSibling);
    }
  }

  function getCustomPrices(tr){
    if(tr.nextSibling && tr.nextSibling.classList && tr.nextSibling.classList.contains('custom-price-row')){
      const e = tr.nextSibling;
      return {
        TM: e.querySelector('.cust-price-tm').value ? Number(e.querySelector('.cust-price-tm').value) : null,
        SM: e.querySelector('.cust-price-sm').value ? Number(e.querySelector('.cust-price-sm').value) : null,
        'SMALL M': e.querySelector('.cust-price-smm').value ? Number(e.querySelector('.cust-price-smm').value) : null,
        'SMALL C': e.querySelector('.cust-price-smc').value ? Number(e.querySelector('.cust-price-smc').value) : null,
        A400: e.querySelector('.cust-price-a400').value ? Number(e.querySelector('.cust-price-a400').value) : null,
        H500: e.querySelector('.cust-price-h500').value ? Number(e.querySelector('.cust-price-h500').value) : null,
        FC400: e.querySelector('.cust-price-fc400').value ? Number(e.querySelector('.cust-price-fc400').value) : null,
        FC1L: e.querySelector('.cust-price-fc1l').value ? Number(e.querySelector('.cust-price-fc1l').value) : null
      };
    }
    return null;
  }

  // calculate one row
  function calculateRow(tr){
    const global = readGlobalPrices();
    const custom = getCustomPrices(tr);

    const tmQty = Number(tr.querySelector('.tm').value || 0);
    const smQty = Number(tr.querySelector('.sm').value || 0);
    const smmQty = Number(tr.querySelector('.smm').value || 0);
    const smcQty = Number(tr.querySelector('.smc').value || 0);
    const a400Qty = Number(tr.querySelector('.a400').value || 0);
    const h500Qty = Number(tr.querySelector('.h500').value || 0);
    const fc400Qty = Number(tr.querySelector('.fc400').value || 0);
    const fc1lQty = Number(tr.querySelector('.fc1l').value || 0);
    const paid = Number(tr.querySelector('.paid').value || 0);

    const p = {
      TM: (custom && custom.TM != null) ? custom.TM : global.TM,
      SM: (custom && custom.SM != null) ? custom.SM : global.SM,
      'SMALL M': (custom && custom['SMALL M'] != null) ? custom['SMALL M'] : global['SMALL M'],
      'SMALL C': (custom && custom['SMALL C'] != null) ? custom['SMALL C'] : global['SMALL C'],
      A400: (custom && custom.A400 != null) ? custom.A400 : global.A400,
      H500: (custom && custom.H500 != null) ? custom.H500 : global.H500,
      FC400: (custom && custom.FC400 != null) ? custom.FC400 : global.FC400,
      FC1L: (custom && custom.FC1L != null) ? custom.FC1L : global.FC1L
    };

    const total = (tmQty * p.TM) + (smQty * p.SM) + (smmQty * p['SMALL M']) + (smcQty * p['SMALL C'])
                + (a400Qty * p.A400) + (h500Qty * p.H500) + (fc400Qty * p.FC400) + (fc1lQty * p.FC1L);
    const due = Math.max(0, total - paid);

    tr.querySelector('.total-cell').textContent = formatNum(total);
    tr.querySelector('.due-cell').textContent = formatNum(due);

    updateTotalsAndLitres();
  }

  // update summary row (top), footer totals, grand totals, litres, remaining
  function updateTotalsAndLitres(){
    let g = 0;
    let tmSum=0, smSum=0, smmSum=0, smcSum=0, a400Sum=0, h500Sum=0, fc400Sum=0, fc1lSum=0;
    let paidSum=0, dueSum=0, totalMoneySum=0;

    const rows = Array.from(dataBody.querySelectorAll('tr')).filter(tr => !(tr.classList && tr.classList.contains('custom-price-row')));
    rows.forEach(tr=>{
      const tm = Number(tr.querySelector('.tm').value || 0);
      const sm = Number(tr.querySelector('.sm').value || 0);
      const smm = Number(tr.querySelector('.smm').value || 0);
      const smc = Number(tr.querySelector('.smc').value || 0);
      const a400 = Number(tr.querySelector('.a400').value || 0);
      const h500 = Number(tr.querySelector('.h500').value || 0);
      const fc400 = Number(tr.querySelector('.fc400').value || 0);
      const fc1l = Number(tr.querySelector('.fc1l').value || 0);

      const total = parseFloat((tr.querySelector('.total-cell').textContent || '0').replace(/,/g,'')) || 0;
      const paid = Number(tr.querySelector('.paid').value || 0);
      const due = parseFloat((tr.querySelector('.due-cell').textContent || '0').replace(/,/g,'')) || 0;

      tmSum += tm; smSum += sm; smmSum += smm; smcSum += smc; a400Sum += a400; h500Sum += h500; fc400Sum += fc400; fc1lSum += fc1l;
      totalMoneySum += total; paidSum += paid; dueSum += due;
      g += total;
    });

    // top summary row
    sumEls.tm.textContent = formatNum(tmSum);
    sumEls.sm.textContent = formatNum(smSum);
    sumEls.smm.textContent = formatNum(smmSum);
    sumEls.smc.textContent = formatNum(smcSum);
    sumEls.a400.textContent = formatNum(a400Sum);
    sumEls.h500.textContent = formatNum(h500Sum);
    sumEls.fc400.textContent = formatNum(fc400Sum);
    sumEls.fc1l.textContent = formatNum(fc1lSum);
    sumEls.total.textContent = formatNum(totalMoneySum);
    sumEls.paid.textContent = formatNum(paidSum);
    sumEls.due.textContent = formatNum(dueSum);

    // footer totals
    footEls.tm.textContent = formatNum(tmSum);
    footEls.sm.textContent = formatNum(smSum);
    footEls.smm.textContent = formatNum(smmSum);
    footEls.smc.textContent = formatNum(smcSum);
    footEls.a400.textContent = formatNum(a400Sum);
    footEls.h500.textContent = formatNum(h500Sum);
    footEls.fc400.textContent = formatNum(fc400Sum);
    footEls.fc1l.textContent = formatNum(fc1lSum);
    footEls.total.textContent = formatNum(totalMoneySum);
    footEls.paid.textContent = formatNum(paidSum);
    footEls.due.textContent = formatNum(dueSum);

    grandEl.textContent = formatNum(g);

    const litresSold = tmSum + smSum + smmSum + smcSum + a400Sum + h500Sum + fc400Sum + fc1lSum;
    grandLitresEl.textContent = formatNum(litresSold);

    const available = Number(totalAvailableInput.value || localStorage.getItem(STORAGE_KEY + '_available') || 0);
    displayAvailable.textContent = formatNum(available);
    const remaining = Math.max(0, available - litresSold);
    remainingEl.textContent = formatNum(remaining);

    topSoldDisplay.textContent = `Total Litres Sold: ${formatNum(litresSold)}`;
    topRemainingDisplay.textContent = `Remaining: ${formatNum(remaining)}`;

    autosaveSilent();
  }

  function formatNum(n){
    if(!isFinite(n)) return '0';
    if(Math.round(n)===n) return String(Math.round(n));
    return Number(n).toFixed(2);
  }

  // collect rows for save/export
  function collectRows(){
    const out = [];
    const rows = Array.from(dataBody.querySelectorAll('tr')).filter(tr => !(tr.classList && tr.classList.contains('custom-price-row')));
    rows.forEach(tr=>{
      const hasCustom = tr.querySelector('.custom-toggle-check') && tr.querySelector('.custom-toggle-check').checked;
      const customPrices = hasCustom ? getCustomPrices(tr) : null;
      const row = {
        shop: tr.querySelector('.shop').value.trim(),
        mobile: tr.querySelector('.mobile').value.trim(),
        TM: tr.querySelector('.tm').value.trim(),
        SM: tr.querySelector('.sm').value.trim(),
        SMALLM: tr.querySelector('.smm').value.trim(),
        SMALLC: tr.querySelector('.smc').value.trim(),
        A400: tr.querySelector('.a400').value.trim(),
        H500: tr.querySelector('.h500').value.trim(),
        FC400: tr.querySelector('.fc400').value.trim(),
        FC1L: tr.querySelector('.fc1l').value.trim(),
        paid: tr.querySelector('.paid').value.trim(),
        customPrices: customPrices
      };
      // keep only meaningful rows (or those with custom prices)
      if(Object.values(row).some(v => v !== '' && v !== null) || row.customPrices) out.push(row);
    });
    return out;
  }

  // save all to localStorage
  function saveData(){
    try{
      const data = {
        rows: collectRows(),
        date: dateInput.value || '',
        prices: readGlobalPrices(),
        available: totalAvailableInput.value || ''
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      showToast('Saved locally');
    }catch(e){
      console.error(e); showToast('Save failed');
    }
  }

  function autosaveSilent(){
    try{
      const data = {
        rows: collectRows(),
        date: dateInput.value || '',
        prices: readGlobalPrices(),
        available: totalAvailableInput.value || ''
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }catch(e){}
  }

  // load from localStorage
  function loadData(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw){
        const data = JSON.parse(raw);
        if(data.prices) {
          // set global prices if present
          if(typeof data.prices.TM !== 'undefined') priceInputs.TM.value = data.prices.TM;
          if(typeof data.prices.SM !== 'undefined') priceInputs.SM.value = data.prices.SM;
          if(typeof data.prices['SMALL M'] !== 'undefined') priceInputs['SMALL M'].value = data.prices['SMALL M'];
          if(typeof data.prices['SMALL C'] !== 'undefined') priceInputs['SMALL C'].value = data.prices['SMALL C'];
          if(typeof data.prices.A400 !== 'undefined') priceInputs.A400.value = data.prices.A400;
          if(typeof data.prices.H500 !== 'undefined') priceInputs.H500.value = data.prices.H500;
          if(typeof data.prices.FC400 !== 'undefined') priceInputs.FC400.value = data.prices.FC400;
          if(typeof data.prices.FC1L !== 'undefined') priceInputs.FC1L.value = data.prices.FC1L;
        }
        if(data.date) dateInput.value = data.date; else dateInput.value = new Date().toISOString().slice(0,10);
        if(data.available) totalAvailableInput.value = data.available;
        dataBody.innerHTML = '';
        if(Array.isArray(data.rows) && data.rows.length){
          data.rows.forEach(r => {
            const tr = createRow(r);
            dataBody.appendChild(tr);
            calculateRow(tr);
          });
          updateTotalsAndLitres();
          return;
        }
      }
    }catch(e){ console.error(e); }
    // default if no saved data: one empty row and today's date
    dataBody.innerHTML = '';
    dataBody.appendChild(createRow());
    dateInput.value = new Date().toISOString().slice(0,10);
    updateTotalsAndLitres();
  }

  // CSV export (mobile-compatible)
  function downloadCSV(){
    const rows = collectRows();
    if(rows.length === 0){ showToast('No data to export'); return; }
    const header = ['Shop FullName','Mobile','TM','SM','SMALL M','SMALL C','A400','H500','FC400','FC1L','Total','Paid','Due','Date','CustomPrices'];
    const lines = [header.join(',')];

    rows.forEach(r=>{
      const tm = +(r.TM||0), sm=+(r.SM||0), smm=+(r.SMALLM||0), smc=+(r.SMALLC||0), a400=+(r.A400||0), h500=+(r.H500||0), fc400=+(r.FC400||0), fc1l=+(r.FC1L||0);
      const global = readGlobalPrices();
      let total = 0; let customDesc = '';
      if(r.customPrices){
        const p = r.customPrices;
        total = tm*(p.TM||global.TM) + sm*(p.SM||global.SM) + smm*((p['SMALL M'])||global['SMALL M']) + smc*((p['SMALL C'])||global['SMALL C']) + a400*((p.A400)||global.A400) + h500*((p.H500)||global.H500) + fc400*((p.FC400)||global.FC400) + fc1l*((p.FC1L)||global.FC1L);
        customDesc = JSON.stringify(r.customPrices).replace(/"/g,"'");
      } else {
        total = tm*global.TM + sm*global.SM + smm*global['SMALL M'] + smc*global['SMALL C'] + a400*global.A400 + h500*global.H500 + fc400*global.FC400 + fc1l*global.FC1L;
      }
      const paid = +(r.paid||0);
      const due = Math.max(0, total - paid);
      const cols = [r.shop, r.mobile, r.TM, r.SM, r.SMALLM, r.SMALLC, r.A400, r.H500, r.FC400, r.FC1L, total.toFixed(2), paid.toFixed(2), due.toFixed(2), dateInput.value || '', customDesc];
      const safe = cols.map(c => `"${String(c).replace(/"/g,'""')}"`);
      lines.push(safe.join(','));
    });

    // summary lines
    lines.push('');
    lines.push(`"Summary:","","TM","SM","SMALL M","SMALL C","A400","H500","FC400","FC1L","Total (₹)","Paid (₹)","Due (₹)","",""`);
    const summaryVals = [ '', '', sumEls.tm.textContent, sumEls.sm.textContent, sumEls.smm.textContent, sumEls.smc.textContent, sumEls.a400.textContent, sumEls.h500.textContent, sumEls.fc400.textContent, sumEls.fc1l.textContent, footEls.total.textContent, footEls.paid.textContent, footEls.due.textContent, dateInput.value || '', '' ];
    lines.push(summaryVals.map(c => `"${String(c).replace(/"/g,'""')}"`).join(','));
    lines.push('');
    const available = totalAvailableInput.value || localStorage.getItem(STORAGE_KEY + '_available') || '';
    const grandLitres = grandLitresEl.textContent || '0';
    const remaining = remainingEl.textContent || '0';
    lines.push(`"Available litres","${available}"`);
    lines.push(`"Total litres sold","${grandLitres}"`);
    lines.push(`"Remaining litres","${remaining}"`);

    const csv = lines.join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    const fname = `MilkSales_${(dateInput.value || new Date().toISOString().slice(0,10))}.csv`;
    a.download = fname;
    a.click();
    URL.revokeObjectURL(url);
    showToast('CSV downloaded');
  }

  // WhatsApp send
  function sendWhatsAppForRow(tr){
    const shop = tr.querySelector('.shop').value || 'Customer';
    let mobile = (tr.querySelector('.mobile').value || '').replace(/\D/g,'');
    if(!mobile){ alert('Please enter mobile number.'); return; }
    if(mobile.length > 10 && mobile.startsWith('91')) mobile = mobile.slice(-10);
    if(mobile.length !== 10){ alert('Enter a valid 10-digit mobile number'); return; }

    const tm = Number(tr.querySelector('.tm').value || 0);
    const sm = Number(tr.querySelector('.sm').value || 0);
    const smm = Number(tr.querySelector('.smm').value || 0);
    const smc = Number(tr.querySelector('.smc').value || 0);
    const a400 = Number(tr.querySelector('.a400').value || 0);
    const h500 = Number(tr.querySelector('.h500').value || 0);
    const fc400 = Number(tr.querySelector('.fc400').value || 0);
    const fc1l = Number(tr.querySelector('.fc1l').value || 0);
    const total = tr.querySelector('.total-cell').textContent || '0';
    const paid = Number(tr.querySelector('.paid').value || 0);
    const due = tr.querySelector('.due-cell').textContent || '0';
    const date = dateInput.value || new Date().toISOString().slice(0,10);

    const global = readGlobalPrices();
    const custom = getCustomPrices(tr);
    const priceUsed = (custom ? {
      TM: custom.TM != null ? custom.TM : global.TM,
      SM: custom.SM != null ? custom.SM : global.SM,
      'SMALL M': custom['SMALL M'] != null ? custom['SMALL M'] : global['SMALL M'],
      'SMALL C': custom['SMALL C'] != null ? custom['SMALL C'] : global['SMALL C'],
      A400: custom.A400 != null ? custom.A400 : global.A400,
      H500: custom.H500 != null ? custom.H500 : global.H500,
      FC400: custom.FC400 != null ? custom.FC400 : global.FC400,
      FC1L: custom.FC1L != null ? custom.FC1L : global.FC1L
    } : global);

    let msg = `Hello ${shop},%0AYour milk bill for ${date}:%0A`;
    const list = [];
    if(tm) list.push(`TM ${tm}x${priceUsed.TM}=${(tm*priceUsed.TM).toFixed(2)}`);
    if(sm) list.push(`SM ${sm}x${priceUsed.SM}=${(sm*priceUsed.SM).toFixed(2)}`);
    if(smm) list.push(`SMALL M ${smm}x${priceUsed['SMALL M']}=${(smm*priceUsed['SMALL M']).toFixed(2)}`);
    if(smc) list.push(`SMALL C ${smc}x${priceUsed['SMALL C']}=${(smc*priceUsed['SMALL C']).toFixed(2)}`);
    if(a400) list.push(`A400 ${a400}x${priceUsed.A400}=${(a400*priceUsed.A400).toFixed(2)}`);
    if(h500) list.push(`H500 ${h500}x${priceUsed.H500}=${(h500*priceUsed.H500).toFixed(2)}`);
    if(fc400) list.push(`FC400 ${fc400}x${priceUsed.FC400}=${(fc400*priceUsed.FC400).toFixed(2)}`);
    if(fc1l) list.push(`FC1L ${fc1l}x${priceUsed.FC1L}=${(fc1l*priceUsed.FC1L).toFixed(2)}`);
    if(list.length) msg += list.join('%0A') + '%0A';
    msg += `Total: ₹${total}%0APaid: ₹${paid.toFixed(2)}%0ADue: ₹${due}%0A- Sambashiva Milk Agency`;

    const waUrl = `https://wa.me/91${mobile}?text=${msg}`;
    window.open(waUrl, '_blank');
  }

  // attach top controls
  addBtn.addEventListener('click', ()=>{ dataBody.appendChild(createRow()); autosaveSilent(); scrollToBottom(); });
  saveBtn.addEventListener('click', saveData);
  exportBtn.addEventListener('click', downloadCSV);

  // when global prices change, recalc all
  Object.values(priceInputs).forEach(inp=>{
    inp.addEventListener('input', ()=>{
      Array.from(dataBody.querySelectorAll('tr')).forEach(tr => calculateRow(tr));
      autosaveSilent();
    });
  });

  dateInput.addEventListener('change', autosaveSilent);
  totalAvailableInput.addEventListener('input', ()=>{ localStorage.setItem(STORAGE_KEY + '_available', totalAvailableInput.value || ''); updateTotalsAndLitres(); });

  function scrollToBottom(){ try{ window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }); }catch(e){} }

  // init
  (function init(){
    loadData();
  })();

})();
</script>
</body>
</html>
