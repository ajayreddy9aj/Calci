        <div class="price-item"><label>H500 (₹)</label><input id="price_H500" type="number" min="0" value="86"></div>
        <div class="price-item"><label>FC400 (₹)</label><input id="price_FC400" type="number" min="0" value="77"></div>
        <div class="price-item"><label>FC1L (₹)</label><input id="price_FC1L" type="number" min="0" value="76"></div>
      </div>

      <!-- top controls -->
      <div class="controls">
        <div style="flex:1"></div>
        <button id="addBtn" class="btn">+ Add Shop</button>
        <button id="clearBtn" class="btn clear small" title="Clear all data">Clear All</button>
        <button id="saveBtn" class="btn ghost small">Save Data</button>
        <button id="exportBtn" class="btn ghost small">Download CSV</button>
      </div>

      <!-- table -->
      <div class="table-wrap" role="region" aria-label="Shops table">
        <table id="dataTable" aria-describedby="tableDesc">
          <thead>
            <tr>
              <th>Full name</th><th>Mobile</th><th>TM</th><th>SM</th><th>SMALL M</th><th>SMALL C</th>
              <th>A400</th><th>H500</th><th>FC400</th><th>FC1L</th><th>Total</th><th>Paid</th><th>Due</th><th>Send</th><th>Custom</th><th>Delete</th>
            </tr>
          </thead>

          <!-- planned row under header (not sticky) -->
          <tbody>
            <tr class="planned-row">
              <td style="text-align:left;padding-left:8px">Planned litres to sell (editable)</td>
              <td>—</td>
              <td><input id="plan_TM" type="number" min="0" value="0"></td>
              <td><input id="plan_SM" type="number" min="0" value="0"></td>
              <td><input id="plan_SMM" type="number" min="0" value="0"></td>
              <td><input id="plan_SMC" type="number" min="0" value="0"></td>
              <td><input id="plan_A400" type="number" min="0" value="0"></td>
              <td><input id="plan_H500" type="number" min="0" value="0"></td>
              <td><input id="plan_FC400" type="number" min="0" value="0"></td>
              <td><input id="plan_FC1L" type="number" min="0" value="0"></td>
              <td id="plan_total">0</td>
              <td colspan="5"></td>
            </tr>
          </tbody>

          <tbody id="dataBody"></tbody>

          <tfoot>
            <tr class="summary-row">
              <td style="text-align:left;padding-left:8px">Totals per column</td>
              <td>—</td>
              <td id="tot_tm">0</td>
              <td id="tot_sm">0</td>
              <td id="tot_smm">0</td>
              <td id="tot_smc">0</td>
              <td id="tot_a400">0</td>
              <td id="tot_h500">0</td>
              <td id="tot_fc400">0</td>
              <td id="tot_fc1l">0</td>
              <td id="tot_total">0</td>
              <td id="tot_paid">0</td>
              <td id="tot_due">0</td>
              <td colspan="3"></td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div style="margin-top:12px;text-align:center;font-weight:700">
        Grand Total: ₹<span id="grandTotal">0</span><br>
        Total Litres Sold: <span id="grandLitres">0</span> Ltrs
      </div>

      <div class="footer-note">Saved locally on this device — data persists after refresh/close.</div>

      <!-- bottom aligned summary -->
      <div class="bottom-summary" id="bottomSummary">
        <div class="summary-grid" role="presentation">
          <div class="summary-label">Metric</div>
          <div class="summary-label">TM</div><div class="summary-label">SM</div><div class="summary-label">SMALL M</div><div class="summary-label">SMALL C</div>
          <div class="summary-label">A400</div><div class="summary-label">H500</div><div class="summary-label">FC400</div><div class="summary-label">FC1L</div>

          <div class="summary-label">Total Litres Sold</div>
          <div class="summary-cell"><span id="b_sold_TM">0</span></div>
          <div class="summary-cell"><span id="b_sold_SM">0</span></div>
          <div class="summary-cell"><span id="b_sold_SMM">0</span></div>
          <div class="summary-cell"><span id="b_sold_SMC">0</span></div>
          <div class="summary-cell"><span id="b_sold_A400">0</span></div>
          <div class="summary-cell"><span id="b_sold_H500">0</span></div>
          <div class="summary-cell"><span id="b_sold_FC400">0</span></div>
          <div class="summary-cell"><span id="b_sold_FC1L">0</span></div>

          <div class="summary-label">Planned Litres</div>
          <div class="summary-cell"><span id="b_plan_TM">0</span></div>
          <div class="summary-cell"><span id="b_plan_SM">0</span></div>
          <div class="summary-cell"><span id="b_plan_SMM">0</span></div>
          <div class="summary-cell"><span id="b_plan_SMC">0</span></div>
          <div class="summary-cell"><span id="b_plan_A400">0</span></div>
          <div class="summary-cell"><span id="b_plan_H500">0</span></div>
          <div class="summary-cell"><span id="b_plan_FC400">0</span></div>
          <div class="summary-cell"><span id="b_plan_FC1L">0</span></div>

          <div class="summary-label">Remaining</div>
          <div class="summary-cell"><span id="b_remain_TM">0</span></div>
          <div class="summary-cell"><span id="b_remain_SM">0</span></div>
          <div class="summary-cell"><span id="b_remain_SMM">0</span></div>
          <div class="summary-cell"><span id="b_remain_SMC">0</span></div>
          <div class="summary-cell"><span id="b_remain_A400">0</span></div>
          <div class="summary-cell"><span id="b_remain_H500">0</span></div>
          <div class="summary-cell"><span id="b_remain_FC400">0</span></div>
          <div class="summary-cell"><span id="b_remain_FC1L">0</span></div>
        </div>
      </div>

    </div>
  </main>

  <div id="toast" class="toast" aria-hidden="true"></div>

<script>
(() => {
  const STORAGE_KEY = 'sambashivaMilkApp_v1';

  // global references
  const priceInputs = {
    TM: document.getElementById('price_TM'),
    SM: document.getElementById('price_SM'),
    'SMALL M': document.getElementById('price_SMM'),
    'SMALL C': document.getElementById('price_SMC'),
    A400: document.getElementById('price_A400'),
    H500: document.getElementById('price_H500'),
    FC400: document.getElementById('price_FC400'),
    FC1L: document.getElementById('price_FC1L')
  };
  const plan = {
    TM: document.getElementById('plan_TM'),
    SM: document.getElementById('plan_SM'),
    'SMALL M': document.getElementById('plan_SMM'),
    'SMALL C': document.getElementById('plan_SMC'),
    A400: document.getElementById('plan_A400'),
    H500: document.getElementById('plan_H500'),
    FC400: document.getElementById('plan_FC400'),
    FC1L: document.getElementById('plan_FC1L')
  };

  const dataBody = document.getElementById('dataBody');
  const addBtn = document.getElementById('addBtn');
  const clearBtn = document.getElementById('clearBtn');
  const saveBtn = document.getElementById('saveBtn');
  const exportBtn = document.getElementById('exportBtn');
  const dateInput = document.getElementById('dateInput');
  const toast = document.getElementById('toast');

  const plan_total = document.getElementById('plan_total');
  const grandTotalEl = document.getElementById('grandTotal');
  const grandLitresEl = document.getElementById('grandLitres');

  const b_sold = {
    TM: document.getElementById('b_sold_TM'),
    SM: document.getElementById('b_sold_SM'),
    'SMALL M': document.getElementById('b_sold_SMM'),
    'SMALL C': document.getElementById('b_sold_SMC'),
    A400: document.getElementById('b_sold_A400'),
    H500: document.getElementById('b_sold_H500'),
    FC400: document.getElementById('b_sold_FC400'),
    FC1L: document.getElementById('b_sold_FC1L')
  };
  const b_plan = {
    TM: document.getElementById('b_plan_TM'),
    SM: document.getElementById('b_plan_SM'),
    'SMALL M': document.getElementById('b_plan_SMM'),
    'SMALL C': document.getElementById('b_plan_SMC'),
    A400: document.getElementById('b_plan_A400'),
    H500: document.getElementById('b_plan_H500'),
    FC400: document.getElementById('b_plan_FC400'),
    FC1L: document.getElementById('b_plan_FC1L')
  };
  const b_remain = {
    TM: document.getElementById('b_remain_TM'),
    SM: document.getElementById('b_remain_SM'),
    'SMALL M': document.getElementById('b_remain_SMM'),
    'SMALL C': document.getElementById('b_remain_SMC'),
    A400: document.getElementById('b_remain_A400'),
    H500: document.getElementById('b_remain_H500'),
    FC400: document.getElementById('b_remain_FC400'),
    FC1L: document.getElementById('b_remain_FC1L')
  };

  const totEls = {
    tm: document.getElementById('tot_tm'),
    sm: document.getElementById('tot_sm'),
    smm: document.getElementById('tot_smm'),
    smc: document.getElementById('tot_smc'),
    a400: document.getElementById('tot_a400'),
    h500: document.getElementById('tot_h500'),
    fc400: document.getElementById('tot_fc400'),
    fc1l: document.getElementById('tot_fc1l'),
    total: document.getElementById('tot_total'),
    paid: document.getElementById('tot_paid'),
    due: document.getElementById('tot_due')
  };

  function showToast(msg, ms = 1400){
    toast.textContent = msg; toast.classList.add('show'); toast.setAttribute('aria-hidden','false');
    clearTimeout(toast._t); toast._t = setTimeout(()=>{ toast.classList.remove('show'); toast.setAttribute('aria-hidden','true'); }, ms);
  }

  // helpers
  function readGlobalPrices(){
    return {
      TM: Number(priceInputs.TM.value || 0),
      SM: Number(priceInputs.SM.value || 0),
      'SMALL M': Number(priceInputs['SMALL M'].value || 0),
      'SMALL C': Number(priceInputs['SMALL C'].value || 0),
      A400: Number(priceInputs.A400.value || 0),
      H500: Number(priceInputs.H500.value || 0),
      FC400: Number(priceInputs.FC400.value || 0),
      FC1L: Number(priceInputs.FC1L.value || 0)
    };
  }
  function formatNum(n){
    if(!isFinite(n)) return '0';
    if(Math.round(n)===n) return String(Math.round(n));
    return Number(n).toFixed(2);
  }

  // create a shop row
  function createRow(data){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input class="shop" type="text" placeholder="Full name"/></td>
      <td><input class="mobile" type="tel" placeholder="10-digit mobile"/></td>
      <td><input class="tm" type="number" min="0" inputmode="numeric" /></td>
      <td><input class="sm" type="number" min="0" inputmode="numeric" /></td>
      <td><input class="smm" type="number" min="0" inputmode="numeric" /></td>
      <td><input class="smc" type="number" min="0" inputmode="numeric" /></td>
      <td><input class="a400" type="number" min="0" inputmode="numeric" /></td>
      <td><input class="h500" type="number" min="0" inputmode="numeric" /></td>
      <td><input class="fc400" type="number" min="0" inputmode="numeric" /></td>
      <td><input class="fc1l" type="number" min="0" inputmode="numeric" /></td>
      <td class="total-cell">0</td>
      <td><input class="paid" type="number" min="0" inputmode="numeric" /></td>
      <td class="due-cell">0</td>
      <td><button class="send-btn" type="button" title="Send WhatsApp">Send</button></td>
      <td><button class="custom-btn" type="button" title="Custom prices">Edit</button></td>
      <td><button class="delete-btn" type="button">Delete</button></td>
    `;

    // fill data if provided
    if(data){
      tr.querySelector('.shop').value = data.shop || '';
      tr.querySelector('.mobile').value = data.mobile || '';
      tr.querySelector('.tm').value = data.TM || '';
      tr.querySelector('.sm').value = data.SM || '';
      tr.querySelector('.smm').value = data.SMALLM || '';
      tr.querySelector('.smc').value = data.SMALLC || '';
      tr.querySelector('.a400').value = data.A400 || '';
      tr.querySelector('.h500').value = data.H500 || '';
      tr.querySelector('.fc400').value = data.FC400 || '';
      tr.querySelector('.fc1l').value = data.FC1L || '';
      tr.querySelector('.paid').value = data.paid || '';
    }

    // input listeners
    tr.querySelectorAll('input').forEach(inp=>{
      inp.addEventListener('input', ()=>{
        calculateRow(tr);
        updateAllSums();
        autosaveSilent();
      });
    });

    // delete
    tr.querySelector('.delete-btn').addEventListener('click', ()=>{
      if(confirm('Delete this row? This action cannot be undone.')){
        // if custom row exists remove
        if(tr.nextSibling && tr.nextSibling.classList && tr.nextSibling.classList.contains('custom-price-row')) tr.parentNode.removeChild(tr.nextSibling);
        tr.parentNode.removeChild(tr);
        updateAllSums();
        autosaveSilent();
      }
    });

    // custom toggle - show/hide a custom price editor row
    tr.querySelector('.custom-btn').addEventListener('click', ()=>{
      toggleCustomRow(tr);
    });

    // send whatsapp
    tr.querySelector('.send-btn').addEventListener('click', ()=> sendWhatsAppForRow(tr));

    return tr;
  }

  // show/hide custom price row for a particular shop row
  function toggleCustomRow(tr, prefill){
    if(tr.nextSibling && tr.nextSibling.classList && tr.nextSibling.classList.contains('custom-price-row')){
      tr.parentNode.removeChild(tr.nextSibling);
      updateAllSums();
      autosaveSilent();
      return;
    }
    const row = document.createElement('tr');
    row.classList.add('custom-price-row');
    row.innerHTML = `<td colspan="16">
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <div style="font-weight:800;color:#7a4300;margin-right:8px">Custom prices for this customer:</div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <label>TM ₹<input class="cust-price-tm" type="number" min="0" style="width:96px;padding:8px" /></label>
          <label>SM ₹<input class="cust-price-sm" type="number" min="0" style="width:96px;padding:8px" /></label>
          <label>SMALL M ₹<input class="cust-price-smm" type="number" min="0" style="width:96px;padding:8px" /></label>
          <label>SMALL C ₹<input class="cust-price-smc" type="number" min="0" style="width:96px;padding:8px" /></label>
          <label>A400 ₹<input class="cust-price-a400" type="number" min="0" style="width:96px;padding:8px" /></label>
          <label>H500 ₹<input class="cust-price-h500" type="number" min="0" style="width:96px;padding:8px" /></label>
          <label>FC400 ₹<input class="cust-price-fc400" type="number" min="0" style="width:96px;padding:8px" /></label>
          <label>FC1L ₹<input class="cust-price-fc1l" type="number" min="0" style="width:96px;padding:8px" /></label>
          <button class="btn small save-cust">Save</button>
          <button class="btn small ghost cancel-cust">Cancel</button>
        </div>
      </div>
    </td>`;
    tr.parentNode.insertBefore(row, tr.nextSibling);

    // set defaults from global prices
    const g = readGlobalPrices();
    row.querySelector('.cust-price-tm').value = g.TM || '';
    row.querySelector('.cust-price-sm').value = g.SM || '';
    row.querySelector('.cust-price-smm').value = g['SMALL M'] || '';
    row.querySelector('.cust-price-smc').value = g['SMALL C'] || '';
    row.querySelector('.cust-price-a400').value = g.A400 || '';
    row.querySelector('.cust-price-h500').value = g.H500 || '';
    row.querySelector('.cust-price-fc400').value = g.FC400 || '';
    row.querySelector('.cust-price-fc1l').value = g.FC1L || '';

    // if prefill object given
    if(prefill){
      row.querySelector('.cust-price-tm').value = prefill.TM ?? row.querySelector('.cust-price-tm').value;
      row.querySelector('.cust-price-sm').value = prefill.SM ?? row.querySelector('.cust-price-sm').value;
      row.querySelector('.cust-price-smm').value = prefill['SMALL M'] ?? row.querySelector('.cust-price-smm').value;
      row.querySelector('.cust-price-smc').value = prefill['SMALL C'] ?? row.querySelector('.cust-price-smc').value;
      row.querySelector('.cust-price-a400').value = prefill.A400 ?? row.querySelector('.cust-price-a400').value;
      row.querySelector('.cust-price-h500').value = prefill.H500 ?? row.querySelector('.cust-price-h500').value;
      row.querySelector('.cust-price-fc400').value = prefill.FC400 ?? row.querySelector('.cust-price-fc400').value;
      row.querySelector('.cust-price-fc1l').value = prefill.FC1L ?? row.querySelector('.cust-price-fc1l').value;
    }

    // handlers
    row.querySelector('.save-cust').addEventListener('click', ()=>{
      // save custom prices into dataset on the main row (so it persists)
      const custom = {
        TM: Number(row.querySelector('.cust-price-tm').value || 0),
        SM: Number(row.querySelector('.cust-price-sm').value || 0),
        'SMALL M': Number(row.querySelector('.cust-price-smm').value || 0),
        'SMALL C': Number(row.querySelector('.cust-price-smc').value || 0),
        A400: Number(row.querySelector('.cust-price-a400').value || 0),
        H500: Number(row.querySelector('.cust-price-h500').value || 0),
        FC400: Number(row.querySelector('.cust-price-fc400').value || 0),
        FC1L: Number(row.querySelector('.cust-price-fc1l').value || 0)
      };
      tr._customPrices = custom;
      calculateRow(tr);
      updateAllSums();
      autosaveSilent();
      showToast('Custom price saved');
    });
    row.querySelector('.cancel-cust').addEventListener('click', ()=>{
      if(row && row.parentNode) row.parentNode.removeChild(row);
    });
  }

  // get custom prices if set
  function getCustomPrices(tr){
    return tr._customPrices || null;
  }

  // calculate a row total/due
  function calculateRow(tr){
    const global = readGlobalPrices();
    const custom = getCustomPrices(tr);
    const tm = Number(tr.querySelector('.tm').value || 0);
    const sm = Number(tr.querySelector('.sm').value || 0);
    const smm = Number(tr.querySelector('.smm').value || 0);
    const smc = Number(tr.querySelector('.smc').value || 0);
    const a400 = Number(tr.querySelector('.a400').value || 0);
    const h500 = Number(tr.querySelector('.h500').value || 0);
    const fc400 = Number(tr.querySelector('.fc400').value || 0);
    const fc1l = Number(tr.querySelector('.fc1l').value || 0);
    const paid = Number(tr.querySelector('.paid').value || 0);

    const p = {
      TM: (custom && typeof custom.TM === 'number' && custom.TM >= 0) ? custom.TM : global.TM,
      SM: (custom && typeof custom.SM === 'number' && custom.SM >= 0) ? custom.SM : global.SM,
      'SMALL M': (custom && typeof custom['SMALL M'] === 'number' && custom['SMALL M'] >= 0) ? custom['SMALL M'] : global['SMALL M'],
      'SMALL C': (custom && typeof custom['SMALL C'] === 'number' && custom['SMALL C'] >= 0) ? custom['SMALL C'] : global['SMALL C'],
      A400: (custom && typeof custom.A400 === 'number' && custom.A400 >= 0) ? custom.A400 : global.A400,
      H500: (custom && typeof custom.H500 === 'number' && custom.H500 >= 0) ? custom.H500 : global.H500,
      FC400: (custom && typeof custom.FC400 === 'number' && custom.FC400 >= 0) ? custom.FC400 : global.FC400,
      FC1L: (custom && typeof custom.FC1L === 'number' && custom.FC1L >= 0) ? custom.FC1L : global.FC1L
    };

    const total = (tm * p.TM) + (sm * p.SM) + (smm * p['SMALL M']) + (smc * p['SMALL C']) + (a400 * p.A400) + (h500 * p.H500) + (fc400 * p.FC400) + (fc1l * p.FC1L);
    const due = Math.max(0, total - paid);

    tr.querySelector('.total-cell').textContent = formatNum(total);
    tr.querySelector('.due-cell').textContent = formatNum(due);
  }

  // update bottom summary and footer totals
  function updateAllSums(){
    let tmSum=0, smSum=0, smmSum=0, smcSum=0, a400Sum=0, h500Sum=0, fc400Sum=0, fc1lSum=0;
    let totalMoneySum=0, paidSum=0, dueSum=0;

    const rows = Array.from(dataBody.querySelectorAll('tr')).filter(r => !r.classList.contains('custom-price-row'));
    rows.forEach(tr=>{
      const tm = Number(tr.querySelector('.tm').value || 0);
      const sm = Number(tr.querySelector('.sm').value || 0);
      const smm = Number(tr.querySelector('.smm').value || 0);
      const smc = Number(tr.querySelector('.smc').value || 0);
      const a400 = Number(tr.querySelector('.a400').value || 0);
      const h500 = Number(tr.querySelector('.h500').value || 0);
      const fc400 = Number(tr.querySelector('.fc400').value || 0);
      const fc1l = Number(tr.querySelector('.fc1l').value || 0);
      const total = parseFloat((tr.querySelector('.total-cell').textContent || '0').replace(/,/g,'')) || 0;
      const paid = Number(tr.querySelector('.paid').value || 0);
      const due = parseFloat((tr.querySelector('.due-cell').textContent || '0').replace(/,/g,'')) || 0;

      tmSum += tm; smSum += sm; smmSum += smm; smcSum += smc; a400Sum += a400; h500Sum += h500; fc400Sum += fc400; fc1lSum += fc1l;
      totalMoneySum += total; paidSum += paid; dueSum += due;
    });

    // footer numbers
    b_sold.TM.textContent = formatNum(tmSum);
    b_sold.SM.textContent = formatNum(smSum);
    b_sold['SMALL M'].textContent = formatNum(smmSum);
    b_sold['SMALL C'].textContent = formatNum(smcSum);
    b_sold.A400.textContent = formatNum(a400Sum);
    b_sold.H500.textContent = formatNum(h500Sum);
    b_sold.FC400.textContent = formatNum(fc400Sum);
    b_sold.FC1L.textContent = formatNum(fc1lSum);

    // planned totals and remaining
    const types = ['TM','SM','SMALL M','SMALL C','A400','H500','FC400','FC1L'];
    let plannedSum = 0;
    types.forEach(t => { plannedSum += Number(plan[t].value || 0); });
    plan_total.textContent = formatNum(plannedSum);

    types.forEach(t => { b_plan[t].textContent = formatNum(Number(plan[t].value || 0)); });
    types.forEach(t => { b_remain[t].textContent = formatNum(Math.max(0, Number(plan[t].value || 0) - Number(b_sold[t].textContent || 0))); });

    // column totals
    totEls.tm.textContent = formatNum(tmSum);
    totEls.sm.textContent = formatNum(smSum);
    totEls.smm.textContent = formatNum(smmSum);
    totEls.smc.textContent = formatNum(smcSum);
    totEls.a400.textContent = formatNum(a400Sum);
    totEls.h500.textContent = formatNum(h500Sum);
    totEls.fc400.textContent = formatNum(fc400Sum);
    totEls.fc1l.textContent = formatNum(fc1lSum);
    totEls.total.textContent = formatNum(totalMoneySum);
    totEls.paid.textContent = formatNum(paidSum);
    totEls.due.textContent = formatNum(dueSum);

    grandTotalEl.textContent = formatNum(totalMoneySum);
    const litresSold = tmSum + smSum + smmSum + smcSum + a400Sum + h500Sum + fc400Sum + fc1lSum;
    grandLitresEl.textContent = formatNum(litresSold);

    autosaveSilent();
  }

  // save/load
  function collectRows(){
    const arr = [];
    const rows = Array.from(dataBody.querySelectorAll('tr')).filter(r => !r.classList.contains('custom-price-row'));
    rows.forEach(tr=>{
      const custom = tr._customPrices || null;
      arr.push({
        shop: tr.querySelector('.shop').value || '',
        mobile: tr.querySelector('.mobile').value || '',
        TM: tr.querySelector('.tm').value || '',
        SM: tr.querySelector('.sm').value || '',
        SMALLM: tr.querySelector('.smm').value || '',
        SMALLC: tr.querySelector('.smc').value || '',
        A400: tr.querySelector('.a400').value || '',
        H500: tr.querySelector('.h500').value || '',
        FC400: tr.querySelector('.fc400').value || '',
        FC1L: tr.querySelector('.fc1l').value || '',
        paid: tr.querySelector('.paid').value || '',
        customPrices: custom
      });
    });
    return arr;
  }

  function saveData(){
    try{
      const payload = {
        date: dateInput.value || new Date().toISOString().slice(0,10),
        prices: readGlobalPrices(),
        plan: {
          TM: Number(plan.TM.value || 0),
          SM: Number(plan.SM.value || 0),
          'SMALL M': Number(plan['SMALL M'].value || 0),
          'SMALL C': Number(plan['SMALL C'].value || 0),
          A400: Number(plan.A400.value || 0),
          H500: Number(plan.H500.value || 0),
          FC400: Number(plan.FC400.value || 0),
          FC1L: Number(plan.FC1L.value || 0)
        },
        rows: collectRows()
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
      showToast('Saved locally');
    }catch(e){
      console.error(e); showToast('Save failed');
    }
  }
  function autosaveSilent(){
    try{
      const payload = {
        date: dateInput.value || new Date().toISOString().slice(0,10),
        prices: readGlobalPrices(),
        plan: {
          TM: Number(plan.TM.value || 0),
          SM: Number(plan.SM.value || 0),
          'SMALL M': Number(plan['SMALL M'].value || 0),
          'SMALL C': Number(plan['SMALL C'].value || 0),
          A400: Number(plan.A400.value || 0),
          H500: Number(plan.H500.value || 0),
          FC400: Number(plan.FC400.value || 0),
          FC1L: Number(plan.FC1L.value || 0)
        },
        rows: collectRows()
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
    }catch(e){}
  }

  function loadData(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw){
        const data = JSON.parse(raw);
        if(data.prices){
          if(typeof data.prices.TM !== 'undefined') priceInputs.TM.value = data.prices.TM;
          if(typeof data.prices.SM !== 'undefined') priceInputs.SM.value = data.prices.SM;
          if(typeof data.prices['SMALL M'] !== 'undefined') priceInputs['SMALL M'].value = data.prices['SMALL M'];
          if(typeof data.prices['SMALL C'] !== 'undefined') priceInputs['SMALL C'].value = data.prices['SMALL C'];
          if(typeof data.prices.A400 !== 'undefined') priceInputs.A400.value = data.prices.A400;
          if(typeof data.prices.H500 !== 'undefined') priceInputs.H500.value = data.prices.H500;
          if(typeof data.prices.FC400 !== 'undefined') priceInputs.FC400.value = data.prices.FC400;
          if(typeof data.prices.FC1L !== 'undefined') priceInputs.FC1L.value = data.prices.FC1L;
        }
        dateInput.value = data.date || new Date().toISOString().slice(0,10);
        if(data.plan){
          Object.keys(plan).forEach(k => { if(typeof data.plan[k] !== 'undefined') plan[k].value = data.plan[k]; });
        }
        dataBody.innerHTML = '';
        if(Array.isArray(data.rows) && data.rows.length){
          data.rows.forEach(r => {
            const tr = createRow(r);
            dataBody.appendChild(tr);
            // restore custom prices if present
            if(r.customPrices) tr._customPrices = r.customPrices;
            calculateRow(tr);
          });
          updateAllSums();
          return;
        }
      }
    }catch(e){ console.error(e); }
    // default
    dataBody.innerHTML = '';
    dataBody.appendChild(createRow());
    dateInput.value = new Date().toISOString().slice(0,10);
    updateAllSums();
  }

  // scroll into view taking header height into account
  function scrollRowIntoView(el){
    const headerH = document.querySelector('header').offsetHeight + 8;
    const rect = el.getBoundingClientRect();
    const absoluteTop = window.scrollY + rect.top;
    window.scrollTo({top: absoluteTop - headerH, behavior: 'smooth'});
  }

  // CSV export (includes planned, sold, remaining)
  function exportCSV(){
    const rows = collectRows();
    const lines = [];
    const types = ['TM','SM','SMALL M','SMALL C','A400','H500','FC400','FC1L'];
    // planned block
    lines.push(`"Planned Litres",${types.map(t=>`"${(plan[t].value||0).toString().replace(/"/g,'""')}"`).join(',')}`);
    lines.push('');
    // header
    lines.push(['Shop','Mobile',...types,'Total','Paid','Due','Date','CustomPrices'].map(c=>`"${c.replace(/"/g,'""')}"`).join(','));
    // rows
    const global = readGlobalPrices();
    rows.forEach(r=>{
      let total = 0;
      const p = r.customPrices || {};
      types.forEach(t=>{
        const q = Number(r[t==='SMALL M' ? 'SMALLM' : (t==='SMALL C' ? 'SMALLC' : t)] || 0);
        const priceUsed = (p && typeof p[t] === 'number') ? p[t] : global[t];
        total += q * (priceUsed || 0);
      });
      const paid = Number(r.paid||0);
      const due = Math.max(0, total - paid);
      const customDesc = r.customPrices ? JSON.stringify(r.customPrices).replace(/"/g,"'") : '';
      const cols = [r.shop||'', r.mobile||'', r.TM||0, r.SM||0, r.SMALLM||0, r.SMALLC||0, r.A400||0, r.H500||0, r.FC400||0, r.FC1L||0, total.toFixed(2), paid.toFixed(2), due.toFixed(2), dateInput.value || '', customDesc];
      lines.push(cols.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(','));
    });
    // summary rows
    lines.push('');
    // sold
    const soldRow = ['Sold', ...types.map(t => `"${(Number(b_sold[t].textContent)||0).toString().replace(/"/g,'""')}"`)];
    lines.push(soldRow.join(','));
    // remaining
    const remainRow = ['Remaining', ...types.map(t => `"${(Number(b_remain[t].textContent)||0).toString().replace(/"/g,'""')}"`)];
    lines.push(remainRow.join(','));

    const csv = lines.join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    const datePart = (dateInput.value || new Date().toISOString().slice(0,10)).replace(/-/g,'');
    a.download = `milk${datePart}.csv`;
    a.click();
    URL.revokeObjectURL(a.href);
    showToast('CSV downloaded');
  }

  // WhatsApp per row
  function sendWhatsAppForRow(tr){
    const shop = tr.querySelector('.shop').value || 'Customer';
    let mobile = (tr.querySelector('.mobile').value || '').replace(/\D/g,'');
    if(!mobile){ alert('Please enter mobile number.'); return; }
    if(mobile.length > 10 && mobile.startsWith('91')) mobile = mobile.slice(-10);
    if(mobile.length !== 10){ alert('Enter a valid 10-digit mobile number'); return; }
    const tm = Number(tr.querySelector('.tm').value || 0);
    const sm = Number(tr.querySelector('.sm').value || 0);
    const smm = Number(tr.querySelector('.smm').value || 0);
    const smc = Number(tr.querySelector('.smc').value || 0);
    const a400 = Number(tr.querySelector('.a400').value || 0);
    const h500 = Number(tr.querySelector('.h500').value || 0);
    const fc400 = Number(tr.querySelector('.fc400').value || 0);
    const fc1l = Number(tr.querySelector('.fc1l').value || 0);
    const total = tr.querySelector('.total-cell').textContent || '0';
    const paid = Number(tr.querySelector('.paid').value || 0);
    const due = tr.querySelector('.due-cell').textContent || '0';
    const date = dateInput.value || new Date().toISOString().slice(0,10);

    const global = readGlobalPrices();
    const custom = getCustomPrices(tr);
    const priceUsed = {
      TM: custom && typeof custom.TM === 'number' ? custom.TM : global.TM,
      SM: custom && typeof custom.SM === 'number' ? custom.SM : global.SM,
      'SMALL M': custom && typeof custom['SMALL M'] === 'number' ? custom['SMALL M'] : global['SMALL M'],
      'SMALL C': custom && typeof custom['SMALL C'] === 'number' ? custom['SMALL C'] : global['SMALL C'],
      A400: custom && typeof custom.A400 === 'number' ? custom.A400 : global.A400,
      H500: custom && typeof custom.H500 === 'number' ? custom.H500 : global.H500,
      FC400: custom && typeof custom.FC400 === 'number' ? custom.FC400 : global.FC400,
      FC1L: custom && typeof custom.FC1L === 'number' ? custom.FC1L : global.FC1L
    };

    let msg = `Hello ${shop},%0AYour milk bill for ${date}:%0A`;
    const list = [];
    if(tm) list.push(`TM ${tm}x${priceUsed.TM}=${(tm*priceUsed.TM).toFixed(2)}`);
    if(sm) list.push(`SM ${sm}x${priceUsed.SM}=${(sm*priceUsed.SM).toFixed(2)}`);
    if(smm) list.push(`SMALL M ${smm}x${priceUsed['SMALL M']}=${(smm*priceUsed['SMALL M']).toFixed(2)}`);
    if(smc) list.push(`SMALL C ${smc}x${priceUsed['SMALL C']}=${(smc*priceUsed['SMALL C']).toFixed(2)}`);
    if(a400) list.push(`A400 ${a400}x${priceUsed.A400}=${(a400*priceUsed.A400).toFixed(2)}`);
    if(h500) list.push(`H500 ${h500}x${priceUsed.H500}=${(h500*priceUsed.H500).toFixed(2)}`);
    if(fc400) list.push(`FC400 ${fc400}x${priceUsed.FC400}=${(fc400*priceUsed.FC400).toFixed(2)}`);
    if(fc1l) list.push(`FC1L ${fc1l}x${priceUsed.FC1L}=${(fc1l*priceUsed.FC1L).toFixed(2)}`);
    if(list.length) msg += list.join('%0A') + '%0A';
    msg += `Total: ₹${total}%0APaid: ₹${paid.toFixed(2)}%0ADue: ₹${due}%0A- Sambashiva Milk Agency`;

    window.open(`https://wa.me/91${mobile}?text=${msg}`, '_blank');
  }

  // public actions
  addBtn.addEventListener('click', ()=>{
    const tr = createRow();
    dataBody.appendChild(tr);
    // ensure visible
    setTimeout(()=> scrollRowIntoView(tr), 80);
    autosaveSilent();
  });

  clearBtn.addEventListener('click', ()=>{
    if(confirm('Clear all data? This will remove all rows and saved data.')) {
      localStorage.removeItem(STORAGE_KEY);
      dataBody.innerHTML = '';
      dataBody.appendChild(createRow());
      updateAllSums();
      showToast('All cleared');
    }
  });

  saveBtn.addEventListener('click', saveData);
  exportBtn.addEventListener('click', exportCSV);

  // global listeners
  Object.values(priceInputs).forEach(inp => inp.addEventListener('input', ()=>{
    // recalc rows using possibly updated global prices
    Array.from(dataBody.querySelectorAll('tr')).forEach(tr=> {
      if(!tr.classList.contains('custom-price-row')) calculateRow(tr);
    });
    updateAllSums();
    autosaveSilent();
  }));
  Object.values(plan).forEach(inp => inp.addEventListener('input', ()=> { updateAllSums(); autosaveSilent(); }));
  dateInput.addEventListener('change', autosaveSilent);

  // save initial / load
  (function init(){
    loadData();
    updateAllSums();
  })();

})();
</script>
</body>
</html>
