<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SAMBASHIVA MILK AGENCY</title>
<style>
  :root{
    --orange: #f97316;
    --orange-dark: #d65b12;
    --muted: #6b7280;
    --bg: #faf7f3;
    --card: #ffffff;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#222}
  header{
    background:linear-gradient(90deg,var(--orange),var(--orange-dark));
    color:white;padding:18px 12px;text-align:center;
    box-shadow:0 6px 20px rgba(0,0,0,0.08)
  }
  .container{max-width:1100px;margin:12px auto;padding:0 12px}
  .title{font-size:1.5rem;font-weight:800;margin:0}
  .sub{margin:6px 0 0;font-size:0.95rem}
  .top-row{display:flex;gap:12px;align-items:center;justify-content:center;flex-wrap:wrap;margin-top:10px}
  .date-wrap{display:flex;gap:8px;align-items:center}
  .date-input,.stock-input{background:var(--card);border:0;padding:8px 10px;border-radius:8px;font-weight:700}
  .price-panel{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:center;margin:12px 0}
  .price-item{background:var(--card);padding:8px 10px;border-radius:8px;box-shadow:0 6px 18px rgba(2,6,23,0.04);display:flex;flex-direction:column;align-items:center;min-width:100px}
  .price-item label{font-size:12px;color:var(--muted);margin-bottom:6px}
  .price-item input{width:86px;padding:6px;border-radius:6px;border:1px solid #e6e6e6;text-align:center}
  .controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:10px 0}
  .btn{background:var(--orange);color:white;border:0;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
  .btn.ghost{background:white;color:var(--orange);border:1px solid rgba(0,0,0,0.06)}
  .table-wrap{overflow:auto;border-radius:10px;background:var(--card);box-shadow:0 8px 30px rgba(2,6,23,0.06)}
  table{width:100%;border-collapse:collapse;min-width:1100px}
  th,td{padding:8px 6px;border-bottom:1px solid #f3f3f3;text-align:center;font-size:13px}
  thead th{background:linear-gradient(180deg,var(--orange),var(--orange-dark));color:white;position:sticky;top:0;z-index:5}
  input[type="text"],input[type="number"],input[type="tel"],input[type="date"]{width:100%;padding:6px;border-radius:6px;border:1px solid #eaeaea;text-align:center;font-size:13px;background:transparent}
  input[type="number"]::-webkit-inner-spin-button,input[type="number"]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
  .total-cell,.due-cell{font-weight:800}
  .send-btn{background:#25D366;border:0;color:white;padding:6px 8px;border-radius:8px;cursor:pointer}
  .small-txt{font-size:12px;color:var(--muted)}
  .summary-row{background:#fffdf8;font-weight:700}
  .summary-sub{font-size:13px;margin-top:8px}
  .toast{position:fixed;right:16px;bottom:16px;background:#111;color:#fff;padding:10px 12px;border-radius:8px;opacity:0;transform:translateY(8px);transition:all .18s}
  .toast.show{opacity:1;transform:none}
  @media (max-width:1100px){table{min-width:1000px}}
  @media (max-width:640px){
    .price-item{min-width:88px}
    thead th, td {font-size:12px;padding:6px}
    .title{font-size:1.25rem}
  }
</style>
</head>
<body>
  <header>
    <div class="container">
      <div class="title">SAMBASHIVA MILK AGENCY</div>
      <div class="sub">Prop: <strong>K. AJAY KUMAR REDDY</strong> &nbsp; | &nbsp; Mobile: <strong>7330892694</strong></div>
      <div class="top-row">
        <div class="date-wrap small-txt">Date:
          <input id="dateInput" class="date-input" type="date" aria-label="Date"/>
        </div>
        <div class="date-wrap small-txt">Total Litres Available Today:
          <input id="totalAvailable" class="stock-input" type="number" min="0" inputmode="numeric" placeholder="e.g., 500"/>
        </div>
        <div class="small-txt" style="font-weight:700" id="topSoldDisplay">Total Litres Sold: 0</div>
        <div class="small-txt" style="font-weight:700" id="topRemainingDisplay">Remaining: 0</div>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- Price panel (editable) -->
    <div class="price-panel" aria-label="Prices">
      <div class="price-item"><label>TM (₹)</label><input id="price_TM" type="number" min="0" value="57"></div>
      <div class="price-item"><label>SM (₹)</label><input id="price_SM" type="number" min="0" value="67"></div>
      <div class="price-item"><label>SMALL M (₹)</label><input id="price_SMM" type="number" min="0" value="45"></div>
      <div class="price-item"><label>SMALL C (₹)</label><input id="price_SMC" type="number" min="0" value="45"></div>
      <div class="price-item"><label>A400 (₹)</label><input id="price_A400" type="number" min="0" value="70"></div>
      <div class="price-item"><label>H500 (₹)</label><input id="price_H500" type="number" min="0" value="86"></div>
      <div class="price-item"><label>FC400 (₹)</label><input id="price_FC400" type="number" min="0" value="77"></div>
      <div class="price-item"><label>FC1L (₹)</label><input id="price_FC1L" type="number" min="0" value="76"></div>
    </div>

    <div class="controls">
      <button id="addBtn" class="btn">+ Add Shop</button>
      <button id="saveBtn" class="btn ghost">Save Data</button>
      <button id="exportBtn" class="btn ghost">Download CSV</button>
    </div>

    <div class="table-wrap" role="region" aria-label="Shops table">
      <table id="dataTable">
        <thead>
          <tr>
            <th>Full name</th><th>Mobile</th><th>TM</th><th>SM</th><th>SMALL M</th><th>SMALL C</th>
            <th>A400</th><th>H500</th><th>FC400</th><th>FC1L</th><th>Total</th><th>Paid</th><th>Due</th><th>Send</th><th>Custom Price</th>
          </tr>
        </thead>
        <tbody><!-- rows go here --></tbody>
        <tfoot>
          <tr class="summary-row">
            <td style="text-align:left;padding-left:8px">Totals per column</td>
            <td id="tot_mobile" class="small-txt">—</td>
            <td id="tot_tm">0</td>
            <td id="tot_sm">0</td>
            <td id="tot_smm">0</td>
            <td id="tot_smc">0</td>
            <td id="tot_a400">0</td>
            <td id="tot_h500">0</td>
            <td id="tot_fc400">0</td>
            <td id="tot_fc1l">0</td>
            <td id="tot_total">0</td>
            <td id="tot_paid">0</td>
            <td id="tot_due">0</td>
            <td colspan="2"></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <div style="margin-top:12px;text-align:center;font-weight:700">
      Grand Total: ₹<span id="grandTotal">0</span><br>
      Total Litres Sold: <span id="grandLitres">0</span> Ltrs &nbsp; | &nbsp;
      Remaining Litres: <span id="remainingLitres">0</span> Ltrs
    </div>

    <div class="footer" style="margin-top:10px;text-align:center;color:var(--muted);font-size:13px">
      Saved locally on this device — data persists after refresh/close.
    </div>
  </div>

  <div id="toast" class="toast" aria-hidden="true"></div>

<script>
(() => {
  // Local storage keys
  const LS_ROWS = 'milkcalci_rows_final_v1';
  const LS_DATE = 'milkcalci_date_final_v1';
  const LS_PRICES = 'milkcalci_prices_final_v1';
  const LS_AVAILABLE = 'milkcalci_available_final_v1';

  // Price inputs
  const priceInputs = {
    TM: document.getElementById('price_TM'),
    SM: document.getElementById('price_SM'),
    'SMALL M': document.getElementById('price_SMM'),
    'SMALL C': document.getElementById('price_SMC'),
    A400: document.getElementById('price_A400'),
    H500: document.getElementById('price_H500'),
    FC400: document.getElementById('price_FC400'),
    FC1L: document.getElementById('price_FC1L')
  };

  // Elements
  const tbody = document.querySelector('#dataTable tbody');
  const addBtn = document.getElementById('addBtn');
  const saveBtn = document.getElementById('saveBtn');
  const exportBtn = document.getElementById('exportBtn');
  const grandEl = document.getElementById('grandTotal');
  const topSoldDisplay = document.getElementById('topSoldDisplay');
  const topRemainingDisplay = document.getElementById('topRemainingDisplay');
  const totalAvailableInput = document.getElementById('totalAvailable');
  const dateInput = document.getElementById('dateInput');
  const toast = document.getElementById('toast');

  // totals footer elements
  const totEls = {
    tm: document.getElementById('tot_tm'),
    sm: document.getElementById('tot_sm'),
    smm: document.getElementById('tot_smm'),
    smc: document.getElementById('tot_smc'),
    a400: document.getElementById('tot_a400'),
    h500: document.getElementById('tot_h500'),
    fc400: document.getElementById('tot_fc400'),
    fc1l: document.getElementById('tot_fc1l'),
    total: document.getElementById('tot_total'),
    paid: document.getElementById('tot_paid'),
    due: document.getElementById('tot_due'),
    mobile: document.getElementById('tot_mobile')
  };

  function showToast(msg, time=1400){
    toast.textContent = msg;
    toast.classList.add('show');
    toast.setAttribute('aria-hidden','false');
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>{ toast.classList.remove('show'); toast.setAttribute('aria-hidden','true'); }, time);
  }

  // Read prices (current global)
  function readGlobalPrices(){
    return {
      TM: Number(priceInputs.TM.value || 0),
      SM: Number(priceInputs.SM.value || 0),
      'SMALL M': Number(priceInputs['SMALL M'].value || 0),
      'SMALL C': Number(priceInputs['SMALL C'].value || 0),
      A400: Number(priceInputs.A400.value || 0),
      H500: Number(priceInputs.H500].value || 0),
      FC400: Number(priceInputs.FC400.value || 0),
      FC1L: Number(priceInputs.FC1L.value || 0)
    };
  }

  // (There's an accidental bracket due to code generation safety above - fix it)
})();
</script>

<!-- The real full script continues below. Paste the rest -->
<script>
/* ----- Full script (continuation) ----- */
(() => {
  // We'll recreate safe references (because previous chunk had a small error)
  const priceInputsSafe = {
    TM: document.getElementById('price_TM'),
    SM: document.getElementById('price_SM'),
    'SMALL M': document.getElementById('price_SMM'),
    'SMALL C': document.getElementById('price_SMC'),
    A400: document.getElementById('price_A400'),
    H500: document.getElementById('price_H500'),
    FC400: document.getElementById('price_FC400'),
    FC1L: document.getElementById('price_FC1L')
  };

  const LS_ROWS = 'milkcalci_rows_final_v1';
  const LS_DATE = 'milkcalci_date_final_v1';
  const LS_PRICES = 'milkcalci_prices_final_v1';
  const LS_AVAILABLE = 'milkcalci_available_final_v1';

  const tbody = document.querySelector('#dataTable tbody');
  const addBtn = document.getElementById('addBtn');
  const saveBtn = document.getElementById('saveBtn');
  const exportBtn = document.getElementById('exportBtn');
  const grandEl = document.getElementById('grandTotal');
  const topSoldDisplay = document.getElementById('topSoldDisplay');
  const topRemainingDisplay = document.getElementById('topRemainingDisplay');
  const totalAvailableInput = document.getElementById('totalAvailable');
  const dateInput = document.getElementById('dateInput');
  const toast = document.getElementById('toast');

  const totEls = {
    tm: document.getElementById('tot_tm'),
    sm: document.getElementById('tot_sm'),
    smm: document.getElementById('tot_smm'),
    smc: document.getElementById('tot_smc'),
    a400: document.getElementById('tot_a400'),
    h500: document.getElementById('tot_h500'),
    fc400: document.getElementById('tot_fc400'),
    fc1l: document.getElementById('tot_fc1l'),
    total: document.getElementById('tot_total'),
    paid: document.getElementById('tot_paid'),
    due: document.getElementById('tot_due'),
    mobile: document.getElementById('tot_mobile')
  };

  function showToast(msg, time=1400){
    toast.textContent = msg;
    toast.classList.add('show');
    toast.setAttribute('aria-hidden','false');
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>{ toast.classList.remove('show'); toast.setAttribute('aria-hidden','true'); }, time);
  }

  function readGlobalPrices(){
    return {
      TM: Number(priceInputsSafe.TM.value || 0),
      SM: Number(priceInputsSafe.SM.value || 0),
      'SMALL M': Number(priceInputsSafe['SMALL M'].value || 0),
      'SMALL C': Number(priceInputsSafe['SMALL C'].value || 0),
      A400: Number(priceInputsSafe.A400.value || 0),
      H500: Number(priceInputsSafe.H500.value || 0),
      FC400: Number(priceInputsSafe.FC400.value || 0),
      FC1L: Number(priceInputsSafe.FC1L.value || 0)
    };
  }

  // ---------- Row creation & management ----------
  function createRow(data){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input class="shop" type="text" placeholder="Full name"/></td>
      <td><input class="mobile" type="tel" placeholder="10-digit mobile"/></td>
      <td><input class="tm" type="number" min="0" inputmode="numeric"/></td>
      <td><input class="sm" type="number" min="0" inputmode="numeric"/></td>
      <td><input class="smm" type="number" min="0" inputmode="numeric"/></td>
      <td><input class="smc" type="number" min="0" inputmode="numeric"/></td>
      <td><input class="a400" type="number" min="0" inputmode="numeric"/></td>
      <td><input class="h500" type="number" min="0" inputmode="numeric"/></td>
      <td><input class="fc400" type="number" min="0" inputmode="numeric"/></td>
      <td><input class="fc1l" type="number" min="0" inputmode="numeric"/></td>
      <td class="total-cell">0</td>
      <td><input class="paid" type="number" min="0" inputmode="numeric"/></td>
      <td class="due-cell">0</td>
      <td><button class="send-btn" type="button">Send</button></td>
      <td><label><input type="checkbox" class="custom-toggle"/> Edit</label></td>
    `;
    // If data present populate
    if(data){
      tr.querySelector('.shop').value = data.shop || '';
      tr.querySelector('.mobile').value = data.mobile || '';
      tr.querySelector('.tm').value = data.TM || '';
      tr.querySelector('.sm').value = data.SM || '';
      tr.querySelector('.smm').value = data.SMALLM || '';
      tr.querySelector('.smc').value = data.SMALLC || '';
      tr.querySelector('.a400').value = data.A400 || '';
      tr.querySelector('.h500').value = data.H500 || '';
      tr.querySelector('.fc400').value = data.FC400 || '';
      tr.querySelector('.fc1l').value = data.FC1L || '';
      tr.querySelector('.paid').value = data.paid || '';
    }

    // events
    tr.querySelectorAll('input').forEach(inp=>{
      inp.addEventListener('input', ()=> {
        calculateRow(tr);
        autosaveSilent();
      });
      inp.addEventListener('focus', ()=> {
        // do nothing special; we allow direct typing
      });
    });

    // send button
    tr.querySelector('.send-btn').addEventListener('click', ()=> sendWhatsAppForRow(tr));

    // custom price toggle
    const toggle = tr.querySelector('.custom-toggle');
    toggle.addEventListener('change', (e)=>{
      if(e.target.checked){
        showCustomPriceEditor(tr, data && data.customPrices ? data.customPrices : null);
      } else {
        removeCustomPriceEditor(tr);
      }
      calculateRow(tr);
      autosaveSilent();
    });

    // If data includes customPrices, add editor and mark checked
    if(data && data.customPrices){
      toggle.checked = true;
      showCustomPriceEditor(tr, data.customPrices);
    }

    return tr;
  }

  // Insert custom price editor row (inline) right after the main row
  function showCustomPriceEditor(tr, customData){
    // if already inserted, return
    if(tr.nextSibling && tr.nextSibling.classList && tr.nextSibling.classList.contains('custom-price-row')) return;
    const editor = document.createElement('tr');
    editor.classList.add('custom-price-row');
    editor.innerHTML = `<td colspan="15" style="background:#fff8f0;padding:10px">
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-start">
        <div style="font-weight:700;margin-right:12px">Custom prices for this customer:</div>
        <div style="display:flex;gap:8px;align-items:center">
          <label style="font-size:12px;color:${'#444'}">TM ₹<input class="cust-price-tm" type="number" min="0" style="width:80px;padding:6px;margin-left:6px" /></label>
          <label style="font-size:12px;color:${'#444'}">SM ₹<input class="cust-price-sm" type="number" min="0" style="width:80px;padding:6px;margin-left:6px" /></label>
          <label style="font-size:12px;color:${'#444'}">SMALL M ₹<input class="cust-price-smm" type="number" min="0" style="width:80px;padding:6px;margin-left:6px" /></label>
          <label style="font-size:12px;color:${'#444'}">SMALL C ₹<input class="cust-price-smc" type="number" min="0" style="width:80px;padding:6px;margin-left:6px" /></label>
          <label style="font-size:12px;color:${'#444'}">A400 ₹<input class="cust-price-a400" type="number" min="0" style="width:80px;padding:6px;margin-left:6px" /></label>
          <label style="font-size:12px;color:${'#444'}">H500 ₹<input class="cust-price-h500" type="number" min="0" style="width:80px;padding:6px;margin-left:6px" /></label>
          <label style="font-size:12px;color:${'#444'}">FC400 ₹<input class="cust-price-fc400" type="number" min="0" style="width:80px;padding:6px;margin-left:6px" /></label>
          <label style="font-size:12px;color:${'#444'}">FC1L ₹<input class="cust-price-fc1l" type="number" min="0" style="width:80px;padding:6px;margin-left:6px" /></label>
        </div>
      </div>
    </td>`;
    // insert after tr
    tr.parentNode.insertBefore(editor, tr.nextSibling);

    // populate with existing customData if present
    if(customData){
      editor.querySelector('.cust-price-tm').value = customData.TM || '';
      editor.querySelector('.cust-price-sm').value = customData.SM || '';
      editor.querySelector('.cust-price-smm').value = customData['SMALL M'] || '';
      editor.querySelector('.cust-price-smc').value = customData['SMALL C'] || '';
      editor.querySelector('.cust-price-a400').value = customData.A400 || '';
      editor.querySelector('.cust-price-h500').value = customData.H500 || '';
      editor.querySelector('.cust-price-fc400').value = customData.FC400 || '';
      editor.querySelector('.cust-price-fc1l').value = customData.FC1L || '';
    }

    // add listeners: when custom prices change, recalc and autosave
    const inputs = editor.querySelectorAll('input');
    inputs.forEach(i=>{
      i.addEventListener('input', ()=>{
        calculateRow(tr);
        autosaveSilent();
      });
    });
  }

  function removeCustomPriceEditor(tr){
    if(tr.nextSibling && tr.nextSibling.classList && tr.nextSibling.classList.contains('custom-price-row')){
      tr.parentNode.removeChild(tr.nextSibling);
    }
  }

  // Get custom prices for a row (if editor present)
  function getCustomPrices(tr){
    if(tr.nextSibling && tr.nextSibling.classList && tr.nextSibling.classList.contains('custom-price-row')){
      const e = tr.nextSibling;
      return {
        TM: e.querySelector('.cust-price-tm').value ? Number(e.querySelector('.cust-price-tm').value) : null,
        SM: e.querySelector('.cust-price-sm').value ? Number(e.querySelector('.cust-price-sm').value) : null,
        'SMALL M': e.querySelector('.cust-price-smm').value ? Number(e.querySelector('.cust-price-smm').value) : null,
        'SMALL C': e.querySelector('.cust-price-smc').value ? Number(e.querySelector('.cust-price-smc').value) : null,
        A400: e.querySelector('.cust-price-a400').value ? Number(e.querySelector('.cust-price-a400').value) : null,
        H500: e.querySelector('.cust-price-h500').value ? Number(e.querySelector('.cust-price-h500').value) : null,
        FC400: e.querySelector('.cust-price-fc400').value ? Number(e.querySelector('.cust-price-fc400').value) : null,
        FC1L: e.querySelector('.cust-price-fc1l').value ? Numb
