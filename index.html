<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Retail Tracker ‚Äî Simple</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;margin:12px;background:#ffffff;color:#0b1220}
  h1{margin:0 0 8px 0;font-size:20px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
  label{font-size:14px}
  button{padding:8px 10px;border-radius:6px;border:1px solid #dbe7ef;background:#f8fafc;cursor:pointer}
  button.primary{background:#06b6d4;color:#fff;border:none}
  .chip{background:#f1f5f9;padding:6px 10px;border-radius:8px;border:1px solid #e6edf3;font-weight:600}
  .table-wrap{overflow:auto;border:1px solid #e6edf3}
  table{width:100%;border-collapse:collapse}
  thead th{background:#f8fafc;padding:8px;border:1px solid #e6edf3;font-size:13px}
  tbody td{padding:6px;border:1px solid #e6edf3;font-size:13px;text-align:center}
  td.left{text-align:left;padding-left:8px}
  input[type="text"], input[type="number"]{padding:6px;border:1px solid #e6edf3;border-radius:6px}
  input.name{width:220px}
  input.mobile{width:160px}
  input.prod{width:44px;text-align:center}
  input.paid,input.due{width:90px;text-align:center}
  .actions button{padding:6px 8px;margin:0 4px}
  /* modal */
  .modal-back{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.35);align-items:center;justify-content:center;z-index:40}
  .modal{background:#fff;padding:14px;border-radius:8px;min-width:300px;box-shadow:0 10px 30px rgba(0,0,0,0.12)}
  .modal table td{padding:6px}
  @media (max-width:700px){
    input.name{width:150px} input.mobile{width:110px} input.prod{width:36px}
  }
</style>
</head>
<body>
  <h1>Daily Retail Sales Tracker ‚Äî Simple</h1>

  <div class="row">
    <label>Date: <input id="dateField" type="date"></label>
    <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <div id="grandTotal" class="chip">Grand Total: ‚Çπ0.00</div>
    </div>
  </div>

  <div class="row" style="margin-top:6px">
    <button id="addRow">‚ûï Add Row</button>
    <button id="saveBtn" class="primary">üíæ Save</button>
    <button id="printBtn">üñ®Ô∏è Print / PDF</button>
  </div>

  <div class="table-wrap" style="margin-top:10px">
    <table id="sheet">
      <thead>
        <tr>
          <th style="min-width:220px">Customer Name</th>
          <th style="min-width:160px">Mobile</th>
          <th>TM500<br><small>‚Çπ56/L</small></th>
          <th>S Milk<br><small>‚Çπ45/L</small></th>
          <th>S Curd<br><small>‚Çπ45/L</small></th>
          <th>B Curd<br><small>‚Çπ68/L</small></th>
          <th>H500<br><small>‚Çπ86/L</small></th>
          <th>FCM500<br><small>‚Çπ77/L</small></th>
          <th>FCM1L<br><small>‚Çπ72/L</small></th>
          <th>SM1L<br><small>‚Çπ66/L</small></th>
          <th>Paid (‚Çπ)</th>
          <th>Due (‚Çπ)</th>
          <th>Edit</th>
          <th>Send</th>
          <th>Del</th>
        </tr>
      </thead>
      <tbody id="body"></tbody>
      <tfoot>
        <tr>
          <td class="left">Totals</td><td></td>
          <td id="tot_TM">0L</td><td id="tot_SM">0L</td><td id="tot_SC">0L</td>
          <td id="tot_BC">0L</td><td id="tot_H5">0L</td><td id="tot_F5">0L</td>
          <td id="tot_F1">0L</td><td id="tot_S1">0L>
          </td><td colspan="5"></td>
        </tr>
      </tfoot>
    </table>
  </div>

  <!-- modal -->
  <div id="modal" class="modal-back">
    <div class="modal">
      <h3 style="margin:0 0 8px 0">Edit Prices (this row)</h3>
      <table>
        <tr><td>TM500:</td><td><input id="m_TM" type="number"></td></tr>
        <tr><td>S Milk:</td><td><input id="m_SM" type="number"></td></tr>
        <tr><td>S Curd:</td><td><input id="m_SC" type="number"></td></tr>
        <tr><td>B Curd:</td><td><input id="m_BC" type="number"></td></tr>
        <tr><td>H500:</td><td><input id="m_H5" type="number"></td></tr>
        <tr><td>FCM500:</td><td><input id="m_F5" type="number"></td></tr>
        <tr><td>FCM1L:</td><td><input id="m_F1" type="number"></td></tr>
        <tr><td>SM1L:</td><td><input id="m_S1" type="number"></td></tr>
      </table>
      <div style="margin-top:10px;display:flex;gap:8px;justify-content:center">
        <button id="saveModal" class="primary">Save</button>
        <button id="cancelModal">Cancel</button>
      </div>
    </div>
  </div>

<script>
/* ---------- config ---------- */
const DEFAULT_PRICES = { TM500:56, S_Milk:45, S_Curd:45, B_Curd:68, H500:86, FCM500:77, FCM1L:72, SM1L:66 };
const STORAGE_KEY = 'retail_simple_v1';

/* ---------- helpers ---------- */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const safeNum = v => { const n = parseFloat(v); return isNaN(n) ? 0 : n; };
const two = n => Number(n).toFixed(2);

/* ---------- elements ---------- */
const body = $('#body');
const dateField = $('#dateField');
const grandTotal = $('#grandTotal');
const addRowBtn = $('#addRow');
const saveBtn = $('#saveBtn');
const printBtn = $('#printBtn');

const modal = $('#modal');
const saveModalBtn = $('#saveModal');
const cancelModalBtn = $('#cancelModal');

/* track which row is being edited */
let editingRow = null;

/* ---------- create row ---------- */
function createRow(values = [], prices = null) {
  // values array length 12: name,mobile,tm,sm,sc,bc,h5,f5,f1,s1,paid,due
  const tr = document.createElement('tr');

  // store custom prices JSON in data-prices attribute if provided
  const pricesAttr = prices ? JSON.stringify(prices) : '';

  tr.innerHTML = `
    <td class="left"><input class="name" type="text" value="${escapeHtml(values[0]||'')}"></td>
    <td><input class="mobile" type="text" value="${escapeHtml(values[1]||'')}"></td>
    <td><input class="prod" data-key="TM500" type="number" min="0" step="0.1" value="${values[2]||''}"></td>
    <td><input class="prod" data-key="S_Milk" type="number" min="0" step="0.1" value="${values[3]||''}"></td>
    <td><input class="prod" data-key="S_Curd" type="number" min="0" step="0.1" value="${values[4]||''}"></td>
    <td><input class="prod" data-key="B_Curd" type="number" min="0" step="0.1" value="${values[5]||''}"></td>
    <td><input class="prod" data-key="H500" type="number" min="0" step="0.1" value="${values[6]||''}"></td>
    <td><input class="prod" data-key="FCM500" type="number" min="0" step="0.1" value="${values[7]||''}"></td>
    <td><input class="prod" data-key="FCM1L" type="number" min="0" step="0.1" value="${values[8]||''}"></td>
    <td><input class="prod" data-key="SM1L" type="number" min="0" step="0.1" value="${values[9]||''}"></td>
    <td><input class="paid" type="number" readonly value="${values[10]||''}"></td>
    <td><input class="due" type="number" min="0" step="0.01" value="${values[11]||''}"></td>
    <td><button class="edit">Edit</button></td>
    <td><button class="send">Send</button></td>
    <td><button class="del">Del</button></td>
  `;
  if(pricesAttr) tr.setAttribute('data-prices', pricesAttr);

  // bind events
  tr.querySelectorAll('.prod').forEach(i => i.addEventListener('input', () => recalcRow(tr)));
  tr.querySelector('.due').addEventListener('input', () => saveCurrentDate());
  tr.querySelector('.edit').addEventListener('click', () => openEdit(tr));
  tr.querySelector('.send').addEventListener('click', () => sendWhatsApp(tr));
  tr.querySelector('.del').addEventListener('click', () => deleteRow(tr));

  return tr;
}

/* escape simple text */
function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/"/g,'&quot;'); }

/* ---------- recalc row & totals ---------- */
function recalcRow(tr){
  // get prices (custom or default)
  const prices = tr.getAttribute('data-prices') ? JSON.parse(tr.getAttribute('data-prices')) : DEFAULT_PRICES;
  const prodInputs = tr.querySelectorAll('.prod');
  const qty = Array.from(prodInputs).map(i => safeNum(i.value));
  const keys = ['TM500','S_Milk','S_Curd','B_Curd','H500','FCM500','FCM1L','SM1L'];
  let total = 0;
  qty.forEach((q,idx) => {
    total += q * (prices[keys[idx]] || DEFAULT_PRICES[keys[idx]]);
  });
  tr.querySelector('.paid').value = two(total);
  // if due empty set 0.00
  const due = tr.querySelector('.due');
  if(due.value === '' || safeNum(due.value) < 0) due.value = '0.00';
  updateTotals();
  saveCurrentDate(); // keep simple: save on change
}

function updateTotals(){
  const rows = $$('tbody#body tr');
  const totals = { TM500:0, S_Milk:0, S_Curd:0, B_Curd:0, H500:0, FCM500:0, FCM1L:0, SM1L:0, amount:0 };
  rows.forEach(r => {
    const prodInputs = r.querySelectorAll('.prod');
    const qty = Array.from(prodInputs).map(i => safeNum(i.value));
    totals.TM500 += qty[0]; totals.S_Milk += qty[1]; totals.S_Curd += qty[2]; totals.B_Curd += qty[3];
    totals.H500 += qty[4]; totals.FCM500 += qty[5]; totals.FCM1L += qty[6]; totals.SM1L += qty[7];
    const prices = r.getAttribute('data-prices') ? JSON.parse(r.getAttribute('data-prices')) : DEFAULT_PRICES;
    const keys = ['TM500','S_Milk','S_Curd','B_Curd','H500','FCM500','FCM1L','SM1L'];
    qty.forEach((q,i) => totals.amount += q * (prices[keys[i]] || DEFAULT_PRICES[keys[i]]));
  });
  $('#tot_TM').textContent = totals.TM500.toFixed(1) + 'L';
  $('#tot_SM').textContent = totals.S_Milk.toFixed(1) + 'L';
  $('#tot_SC').textContent = totals.S_Curd.toFixed(1) + 'L';
  $('#tot_BC').textContent = totals.B_Curd.toFixed(1) + 'L';
  $('#tot_H5').textContent = totals.H500.toFixed(1) + 'L';
  $('#tot_F5').textContent = totals.FCM500.toFixed(1) + 'L';
  $('#tot_F1').textContent = totals.FCM1L.toFixed(1) + 'L';
  $('#tot_S1').textContent = totals.SM1L.toFixed(1) + 'L';
  grandTotal.textContent = 'Grand Total: ‚Çπ' + totals.amount.toFixed(2);
}

/* ---------- add/delete ---------- */
$('#addRow').addEventListener('click', ()=> {
  const r = createRow();
  body.appendChild(r);
  r.querySelector('.name').focus();
});

function deleteRow(tr){
  if(!confirm('Delete this row?')) return;
  tr.remove();
  saveCurrentDate();
  updateTotals();
}

/* ---------- modal edit prices ---------- */
function openEdit(tr){
  editingRow = tr;
  const prices = tr.getAttribute('data-prices') ? JSON.parse(tr.getAttribute('data-prices')) : DEFAULT_PRICES;
  $('#m_TM').value = prices.TM500;
  $('#m_SM').value = prices.S_Milk;
  $('#m_SC').value = prices.S_Curd;
  $('#m_BC').value = prices.B_Curd;
  $('#m_H5').value = prices.H500;
  $('#m_F5').value = prices.FCM500;
  $('#m_F1').value = prices.FCM1L;
  $('#m_S1').value = prices.SM1L;
  modal.style.display = 'flex';
}
$('#cancelModal').addEventListener('click', ()=> { modal.style.display = 'none'; editingRow = null; });
$('#saveModal').addEventListener('click', ()=> {
  if(!editingRow) { modal.style.display = 'none'; return; }
  const newP = {
    TM500: safeNum($('#m_TM').value || DEFAULT_PRICES.TM500),
    S_Milk: safeNum($('#m_SM').value || DEFAULT_PRICES.S_Milk),
    S_Curd: safeNum($('#m_SC').value || DEFAULT_PRICES.S_Curd),
    B_Curd: safeNum($('#m_BC').value || DEFAULT_PRICES.B_Curd),
    H500: safeNum($('#m_H5').value || DEFAULT_PRICES.H500),
    FCM500: safeNum($('#m_F5').value || DEFAULT_PRICES.FCM500),
    FCM1L: safeNum($('#m_F1').value || DEFAULT_PRICES.FCM1L),
    SM1L: safeNum($('#m_S1').value || DEFAULT_PRICES.SM1L)
  };
  editingRow.setAttribute('data-prices', JSON.stringify(newP));
  recalcRow(editingRow);
  modal.style.display = 'none';
  editingRow = null;
});

/* ---------- WhatsApp send ---------- */
function sendWhatsApp(tr){
  const inputs = tr.querySelectorAll('input');
  const name = inputs[0].value || 'Customer';
  const mobileRaw = inputs[1].value || '';
  const mobile = mobileRaw.replace(/\D/g,'');
  if(!mobile){ alert('Enter mobile number to send'); return; }
  const prodInputs = tr.querySelectorAll('.prod');
  const qty = Array.from(prodInputs).map(i => safeNum(i.value));
  const keys = ['TM500','S_Milk','S_Curd','B_Curd','H500','FCM500','FCM1L','SM1L'];
  const prices = tr.getAttribute('data-prices') ? JSON.parse(tr.getAttribute('data-prices')) : DEFAULT_PRICES;
  const items = [];
  qty.forEach((q,idx)=> { if(q) items.push(`${keys[idx]} ${q}L x ‚Çπ${prices[keys[idx]]}`); });
  const total = safeNum(tr.querySelector('.paid').value);
  const due = safeNum(tr.querySelector('.due').value);
  const date = dateField.value || '';
  let msg = `Hi ${name},%0AYour bill for ${date}:%0A`;
  if(items.length) msg += items.join('%0A') + '%0A';
  msg += `Total: ‚Çπ${two(total)}%0APaid: ‚Çπ${two(total)}%0ADue: ‚Çπ${two(due)}`;
  window.open(`https://wa.me/${mobile}?text=${msg}`, '_blank');
}

/* ---------- save/load per date ---------- */
function saveCurrentDate(){
  const date = dateField.value;
  if(!date){ alert('Pick a date first'); return; }
  const all = loadAll();
  const rows = $$('tbody#body tr').map(tr => {
    const inputs = tr.querySelectorAll('input');
    const arr = Array.from(inputs).map(i => i.value || '');
    return { vals: arr, prices: tr.getAttribute('data-prices') || '' };
  });
  all[date] = rows;
  localStorage.setItem(STORAGE_KEY, JSON.stringify(all));
  saveBtn.textContent = 'Saved ‚úì';
  setTimeout(()=> saveBtn.textContent = 'üíæ Save', 700);
}

function loadAll(){
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); } catch(e) { return {}; }
}

function loadDate(date){
  const all = loadAll();
  body.innerHTML = '';
  if(all[date] && Array.isArray(all[date]) && all[date].length){
    all[date].forEach(obj => {
      const vals = obj.vals || [];
      const prices = obj.prices ? JSON.parse(obj.prices) : null;
      const tr = createRow(vals, prices);
      body.appendChild(tr);
    });
  } else {
    // if no data for this date, try last known or create single blank row
    const keys = Object.keys(all).sort().reverse();
    if(keys.length){
      const last = all[keys[0]];
      if(last && last.length){
        last.forEach(obj => {
          const vals = obj.vals || [];
          const prices = obj.prices ? JSON.parse(obj.prices) : null;
          const tr = createRow(vals, prices);
          body.appendChild(tr);
        });
      } else {
        body.appendChild(createRow());
      }
    } else {
      body.appendChild(createRow());
    }
  }
  // ensure recalc and event binding (createRow already binds)
  $$('tbody#body tr').forEach(tr => recalcRow(tr));
  updateTotals();
}

/* ---------- print ---------- */
function openPrint(){
  const date = dateField.value || '';
  let html = `<html><head><title>Daily Sales - ${date}</title><style>body{font-family:Arial;padding:12px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #ccc;padding:6px;text-align:center}</style></head><body>`;
  html += `<h2>Daily Sales - ${date}</h2>`;
  html += `<table><thead>${$('#sheet thead').innerHTML}</thead><tbody>`;
  $$('tbody#body tr').forEach(r => {
    const vals = Array.from(r.querySelectorAll('input')).slice(0,12).map(i => i.value || '');
    html += '<tr>' + vals.map(v => `<td>${escapeHtml(v)}</td>`).join('') + '</tr>';
  });
  html += `</tbody></table><h3>${grandTotal.textContent}</h3></body></html>`;
  const w = window.open('','_blank');
  w.document.write(html); w.document.close(); w.focus();
  setTimeout(()=> w.print(), 300);
}

/* ---------- init ---------- */
function init(){
  const today = new Date().toISOString().slice(0,10);
  dateField.value = today;
  loadDate(today);
  dateField.addEventListener('change', ()=> loadDate(dateField.value));
  addRowBtn.addEventListener('click', ()=> {
    const tr = createRow();
    body.appendChild(tr);
    tr.querySelector('.name').focus();
  });
  saveBtn.addEventListener('click', saveCurrentDate);
  printBtn.addEventListener('click', openPrint);
  // autosave interval (light)
  setInterval(()=> { try{ saveCurrentDate(); }catch(e){} }, 8000);
  updateTotals();
}
init();
</script>
</body>
</html>
